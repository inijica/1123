<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TomorrowsGirlfriend - Integrated System</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&family=Oswald:wght@700&family=Press+Start+2P&family=Rubik+Glitch&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ========== GLOBAL VARIABLES ========== */
        :root {
            --bg-color: #f0f2f5;
            --line-color: #1a1a1a;
            --erina-color: #cd84f1; /* 绘里奈主色：紫色 */
            --ayane-color: #feca57;  /* 绾音主色：黄色 */
            --accent-yellow: #feca57;
            --accent-purple: #cd84f1;
            --accent-cyan: #7efff5;
            --accent-pink: #ff69b4;
            --accent-blue: #70a1ff;
            --card-white: #fff;
            --shadow-hard: 4px 4px 0 var(--line-color);
            --purple-dark: #2d0046;
            --badge-red: #ff4757;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background-color: transparent;
            font-family: 'Noto Sans SC', sans-serif;
            color: var(--line-color);
            display: flex; align-items: flex-start; justify-content: center;
            overflow: hidden;
        }

        /* ========== MAIN CONTAINER ========== */
        .page-container {
            position: relative;
            /* Base Mobile Resolution (3:4) */
            width: 600px;
            height: 800px;
            background-color: var(--bg-color);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
            flex-shrink: 0; /* Prevent flex compression */
            display: flex; flex-direction: column;
            border: 4px solid var(--line-color);
            transform-origin: top center;

            /* Global Font Size Boost for Mobile Readability */
            font-size: 14px; /* Unified Desktop Base Size */
        }

        .bg-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image:
                linear-gradient(var(--line-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--line-color) 1px, transparent 1px);
            background-size: 40px 40px; opacity: 0.05; z-index: 0;
            pointer-events: none;
        }

        /* ========== GLOBAL HEADER ========== */
        .header-group { flex-shrink: 0; z-index: 100; position: relative; background: var(--bg-color); }

        .sys-header {
            background: transparent;
            padding: 8px 20px;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--line-color); font-family: 'Oswald', sans-serif; font-size: 14px;
        }

        .world-info-bar {
            background: transparent; color: var(--line-color);
            font-family: 'Noto Sans SC', monospace; font-size: 12px;
            padding: 6px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: none; font-weight: 700;
        }
        .world-blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .marquee-container {
            background: #000;
            border-bottom: 2px solid #000; border-top: 2px solid #000;
            height: 45px; /* Increased from 35px */
            overflow: hidden; white-space: nowrap;
            display: flex; align-items: center;
            color: var(--accent-yellow);
        }
        .marquee-content {
            display: inline-block; font-size: 18px; /* Increased from 16px */ font-weight: 900;
            line-height: 45px;
            animation: marquee-scroll 40s linear infinite;
            white-space: nowrap;
        }
        .marquee-item {
            display: inline-block;
            margin-right: 100px;
            cursor: pointer;
        }
        @keyframes marquee-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* ========== MAIN TABS CONTENT ========== */
        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        .tab-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column;
            background: var(--bg-color);
            overflow-y: auto; overflow-x: hidden;
            padding-bottom: 60px; /* Space for Dock Nav */
        }
        .tab-content.active { display: flex; }

        /* ========== TAB 1: HOME ========== */
        .hero-banner {
            margin: 10px 15px;
            background: #fff; border: 3px solid var(--line-color);
            padding: 10px;
            position: relative; z-index: 2;
            box-shadow: var(--shadow-hard);
            height: 140px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .hero-left { z-index: 2; width: 45%; }
        /* Home Tab Elements Boost */
        .hero-title { font-family: 'Oswald', sans-serif; font-size: 20px; line-height: 0.9; text-transform: uppercase; font-weight: 700; }
        .hero-sub { background: #000; color: #fff; display: inline-block; font-size: 14px; font-weight: bold; padding: 2px 4px; margin-top: 5px; transform: skewX(-10deg); }
        .logo-main { font-family: 'Rubik Glitch', cursive; font-size: 32px; line-height: 0.85; color: var(--line-color); text-transform: uppercase; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); letter-spacing: -1px; }
        .since-tag { font-family: 'Oswald', sans-serif; font-size: 14px; letter-spacing: 2px; color: #888; margin-top: 3px; }

        .archive-list { padding: 0 15px; display: flex; flex-direction: column; gap: 10px; position: relative; z-index: 2; flex: 1; justify-content: flex-start; margin-top: 10px; }
        .archive-card {
            background: #fff; border: 2.5px solid var(--line-color);
            display: flex; position: relative;
            min-height: 120px;
            box-shadow: var(--shadow-hard); transition: all 0.2s ease;
            cursor: pointer;
        }
        .archive-card:hover { transform: translateY(-3px); box-shadow: 6px 6px 0 var(--line-color); }
        .archive-card:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--line-color); }

        .card-avatar-box { width: 120px; border-right: 2.5px solid var(--line-color); padding: 4px; background: repeating-linear-gradient(45deg, #eee, #eee 5px, #fff 5px, #fff 10px); display: flex; align-items: center; justify-content: center; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border: 2px solid var(--line-color); }
        .card-info-box { flex: 1; padding: 6px 8px 18px 8px; display: flex; flex-direction: column; position: relative; }
        .info-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .name-main { font-size: 20px; font-weight: 900; line-height: 1; } /* Up from 14px */
        .name-sub { font-size: 14px; color: #888; font-weight: 700; text-transform: uppercase; margin-top: 2px;}
        .rank-badge { font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: bold; background: #000; color: #fff; padding: 2px 8px; border-radius: 4px; display: flex; align-items: center; gap: 3px; }
        .rank-badge i { font-size: 12px; color: gold; }
        .stats-row { display: flex; gap: 8px; margin-bottom: auto; }
        .stat-col { flex: 1; }
        .stat-label { font-size: 14px; font-weight: 700; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .mini-progress { height: 8px; background: #eee; border: 2px solid #000; border-radius: 4px; overflow: hidden; }
        .mini-fill { height: 100%; width: 0%; }
        .tags-row { display: flex; gap: 4px; margin-top: 6px; margin-bottom: 2px; }
        .tag { font-size: 14px; border: 1.5px solid var(--line-color); padding: 0 5px; font-weight: 700; border-radius: 10px; }
        .status-strip { position: absolute; bottom: 0; left: 0; width: 100%; height: 18.5px; border-top: 1px solid var(--line-color); display: flex; align-items: center; justify-content: flex-end; padding: 0 10px; font-size: 14px; font-weight: 900; gap: 6px; }
        .status-light { width: 10px; height: 10px; border-radius: 50%; border: 1.5px solid #000; background: #999; }

        .card-erina .status-strip { background: var(--erina-color); }
        .card-erina .rank-badge { color: var(--erina-color); }
        .card-erina .mini-fill { background: var(--erina-color); }
        .card-AYANE .status-strip { background: var(--ayane-color); color: #000; }
        .card-AYANE .rank-badge { color: var(--ayane-color); }
        .card-AYANE .mini-fill { background: var(--ayane-color); }
        .card-locked { opacity: 0.6; filter: grayscale(1); display: flex; }

        /* ========== TAB 2: MIND SCAN ========== */
        .mind-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.9); border-bottom: 2.5px solid var(--line-color); z-index: 10; }
        .mind-title { font-family: 'Oswald', sans-serif; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .mind-title .blink { animation: blink 1s infinite; font-size: 14px; color: #0f0; background: #000; padding: 2px 4px; border-radius: 2px; }

        .mind-list { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 20px; }
        .mind-card { position: relative; width: 100%; min-height: 220px; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .mind-card.flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); border: 2.5px solid var(--line-color); overflow: hidden; display: flex; flex-direction: column; }
        .face-surface { background-color: #fff; transform: rotateY(0deg); z-index: 2; }
        .face-inner { background-color: #fff9f9; transform: rotateY(180deg); z-index: 1; color: #333; border-color: var(--theme-color); position: relative; }
        .face-inner::before { content: '❤'; position: absolute; top: 10px; right: 40px; font-size: 20px; color: var(--theme-color); opacity: 0.2; transform: rotate(15deg); }
        .card-header-mind { padding: 8px 12px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .toggle-btn { cursor: pointer; width: 36px; height: 36px; border: 2px solid var(--line-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; }
        .card-body-mind { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .mind-avatar-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .mind-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--line-color); object-fit: cover; flex-shrink: 0; }
        .bubble { background: #f0f2f5; padding: 10px; border-radius: 0 12px 12px 12px; font-size: 16px; line-height: 1.4; color: #333; font-weight: 500; -webkit-font-smoothing: antialiased; }
        .mood-bar-container { margin-top: auto; padding-top: 10px; border-top: 1px dashed #eee; }
        .mood-info { display: block; text-align: center; font-size: 14px; font-weight: 900; }
        .progress-mind { display: none; }
        .fill-mind { display: none; }
        .face-inner .card-header-mind { background: #fff; border-bottom: 1px solid #eee; color: var(--theme-color); font-weight: 900; }
        .face-inner .toggle-btn { border-color: var(--theme-color); background: #fff; color: var(--theme-color); }
        .warm-content { font-family: 'Noto Sans SC', sans-serif; font-size: 16px; line-height: 1.6; padding: 10px; position: relative; }
        .heart-icon { color: #ff4757; font-size: 14px; margin-right: 4px; }
        .inner-text { color: #555; padding: 12px; border: 2px dashed var(--theme-color); border-radius: 12px; margin-top: 10px; background: rgba(255,255,255,0.8); position: relative; font-style: italic; }
        .inner-text::after { content: '✨'; position: absolute; bottom: -8px; right: 10px; font-size: 14px; }
        .soft-pulse { animation: soft-pulse 2s infinite ease-in-out; color: var(--theme-color); font-weight: bold; }
        @keyframes soft-pulse { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.02); } }
        .deco-dots { display: flex; gap: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .red { background: #ff5f56; } .yellow { background: #ffbd2e; } .green { background: #27c93f; }
        .theme-erina { --theme-color: #cd84f1; }
        .theme-AYANE { --theme-color: #feca57; }
        .theme-erina .face-inner { background: linear-gradient(135deg, #f8f0ff 0%, #f0e6ff 100%); }
        .theme-AYANE .face-inner { background: linear-gradient(135deg, #fff9e6 0%, #fff4d1 100%); }
        .theme-erina .val { color: var(--erina-color); }
        .theme-AYANE .val { color: var(--ayane-color); }

        /* ========== TAB 3: CHAT ========== */
        /* Chat List */
        .chat-view-container { width: 100%; height: 100%; position: relative; }
        .chat-list-view { width: 100%; height: 100%; display: flex; flex-direction: column; transition: transform 0.3s; position: absolute; top:0; left:0; background:var(--bg-color); z-index: 10; }
        .chat-list-view.hidden { transform: translateX(-30%); opacity: 0; pointer-events: none; }

        .chat-detail-view { width: 100%; height: 100%; display: flex; flex-direction: column; transition: transform 0.3s; position: absolute; top:0; left:0; background: #fff; transform: translateX(100%); z-index: 20; }
        .chat-detail-view.active { transform: translateX(0); }

        .chat-header { flex-shrink: 0; height: 55px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 2px solid var(--line-color); background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); }
        .brand-title { font-family: 'Rubik Glitch', cursive; font-size: 20px; color: var(--line-color); line-height: 1; display: flex; align-items: center; gap: 8px; }
        .total-badge { background: var(--badge-red); color: #fff; font-family: 'Oswald', sans-serif; font-size: 14px; padding: 2px 8px; border-radius: 12px; vertical-align: middle; transform: translateY(-2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
        .total-badge.hidden { display: none; }
        .header-btn { font-size: 18px; cursor: pointer; color: #333; }

        .chat-list { flex: 1; overflow-y: auto; padding: 10px 0 80px 0; }
        .chat-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .chat-item:hover { background: #f5f5f5; }
        .item-avatar-box { position: relative; }
        .item-avatar { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--line-color); object-fit: cover; }
        .item-badge { position: absolute; top: -2px; right: -2px; background: var(--badge-red); color: #fff; font-size: 14px; font-weight: bold; padding: 1px 5px; min-width: 18px; text-align: center; border-radius: 10px; border: 1.5px solid #fff; transition: opacity 0.3s; }
        .item-badge.hidden { opacity: 0; }
        .item-content { flex: 1; min-width: 0; }
        .item-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .item-name { font-weight: 900; font-size: 18px; }
        .item-time { font-size: 14px; color: #999; font-weight: 700; }
        .item-msg { font-size: 18px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Chat Detail */
        .detail-header-info { display: flex; align-items: center; gap: 10px; }
        .header-avatar { width: 40px; height: 40px; border-radius: 50%; border: 1.5px solid #000; object-fit: cover; }
        .header-name { font-weight: 900; font-size: 16px; }
        .chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background: #f4f4f7; -webkit-overflow-scrolling: touch; padding-bottom: 120px; }
        .date-divider { text-align: center; margin: 15px 0; position: relative; display: flex; align-items: center; justify-content: center; }
        .date-divider::before { content: ''; position: absolute; left: 10%; right: 10%; height: 1px; background: #ddd; z-index: 1; }
        .date-tag { background: #f4f4f7; color: #999; font-size: 14px; padding: 2px 12px; border-radius: 4px; font-weight: 900; position: relative; z-index: 2; text-transform: uppercase; letter-spacing: 1px; }

        /* Pregnancy Status */
        .pregnancy-badge {
            position: absolute;
            bottom: 25%;
            right: 68%;
            z-index: 100;
            display: none;
            perspective: 1000px;
            cursor: pointer;
            pointer-events: auto;
            min-width: 130px;
            transform: scale(0.85);
            transform-origin: right center;
        }
        .pregnancy-badge.active { display: block; animation: fadeIn 0.5s ease; }

        .pregnancy-inner {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            width: 100%;
            height: 40px; /* 增加高度 */
        }

        .pregnancy-badge.flipped .pregnancy-inner {
            transform: rotateY(180deg);
        }

        .pregnancy-front, .pregnancy-back {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 16px;
            border-radius: 20px;
            white-space: nowrap;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            box-shadow: 0 4px 12px rgba(255, 77, 109, 0.25);
            border: 2px solid #ff4d6d;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
        }

        .pregnancy-front {
            background: linear-gradient(135deg, #fff0f3 0%, #ffeef2 100%);
        }

        .pregnancy-back {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #ff4d6d 0%, #ff758c 100%);
            color: #fff;
            border-color: #ff4d6d;
        }

        .pregnancy-icon { color: #ff4d6d; font-size: 20px; animation: heartbeat 1.5s infinite; }
        .pregnancy-back .pregnancy-icon { color: #fff; font-size: 16px; }

        /* 正面文字更大 */
        .pregnancy-front .pregnancy-text { font-size: 18px; font-weight: 900; color: #ff4d6d; letter-spacing: 1px; }
        /* 背面日期文字明显更小 */
        .pregnancy-back .pregnancy-text { color: #fff; font-size: 12px; font-family: 'Oswald', sans-serif; letter-spacing: 0.5px; }

        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .msg-row { display: flex; align-items: flex-start; margin: 0; padding: 0; max-width: 100%; transition: all 0.3s ease; }
        .msg-row.right { flex-direction: row-reverse; }
        .msg-avatar { width: 55px; height: 55px; border-radius: 50%; background-size: cover; background-position: center; margin-right: 10px; flex-shrink: 0; box-shadow: 0 3px 6px rgba(0,0,0,0.1); border: 2px solid #fff; }
        .right .msg-avatar { margin-right: 0; margin-left: 10px; border: 2px solid var(--line-color); }
        .msg-content-wrapper { max-width: calc(100% - 60px); display: flex; flex-direction: column; }
        .left .msg-content-wrapper { align-items: flex-start; }
        .right .msg-content-wrapper { align-items: flex-end; }
        .msg-name {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 2px;
            opacity: 0.9;
        }
        .right .msg-name { color: var(--line-color); }
        .msg-bubble { display: inline-block; padding: 14px 18px; font-size: 18px; line-height: 1.5; word-wrap: break-word; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        .left .msg-bubble { border-radius: 4px 18px 18px 18px; }
        .right .msg-bubble { background: #fff; color: #000; border-radius: 18px 4px 18px 18px; border: 1.5px solid var(--line-color); }
        .style-AYANE .msg-avatar { border: 2px solid var(--ayane-color); }
        .style-AYANE .msg-name { color: #b8860b; }
        .style-AYANE .msg-bubble { border-radius: 4px 18px 18px 18px; background: linear-gradient(145deg, #2b2b2b, #1a1a1a); color: var(--ayane-color); border: 1px solid rgba(254, 202, 87, 0.3); box-shadow: 0 3px 10px rgba(254, 202, 87, 0.15), inset 1px 1px 2px rgba(255,255,255,0.05); }
        .style-erina .msg-avatar { border: 2px solid var(--erina-color); }
        .style-erina .msg-name { color: var(--erina-color); }
        .style-erina .msg-bubble { border-radius: 4px 18px 18px 18px; background: linear-gradient(145deg, #1e1a24, #121016); color: #e8e0f3; box-shadow: 0 2px 8px rgba(138, 43, 226, 0.25), inset 1px 1px 2px rgba(255, 255, 255, 0.05); }

        /* Group Chat Styles */
        .style-group .msg-avatar { border: 2px solid #555; }
        .style-group .msg-name { color: #555; font-weight: 700; }
        .style-group .msg-bubble { border-radius: 4px 18px 18px 18px; background: #fff; color: #333; border: 1px solid #ddd; }
        .style-group.right .msg-bubble { background: var(--line-color); color: #fff; border-color: var(--line-color); border-radius: 18px 4px 18px 18px; }
        .style-group.right .msg-name { color: var(--line-color); }

        .msg-meta { font-size: 14px; opacity: 0.6; margin-top: 4px; text-align: right; font-weight: 700; }
        .msg-media-desc { font-size: 16px; opacity: 0.8; margin-top: 5px; font-style: italic; background: rgba(0,0,0,0.1); padding: 4px; border-radius: 4px; border-left: 2px solid var(--accent-yellow); }
        .voice-wrapper { display: flex; align-items: center; gap: 8px; }
        .voice-player { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.1); padding: 5px 10px; border-radius: 20px; }
        .voice-icon { font-size: 16px; }
        .voice-wave { display: flex; gap: 2px; height: 10px; align-items: center; }
        .wave-bar { width: 2px; background: #000; animation: wave 1s infinite; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 60%; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 40%; }
        @keyframes wave { 0%, 100% { height: 40%; } 50% { height: 100%; } }

        /* Call Bubbles */
        .call-bubble { display: flex; align-items: center; gap: 10px; background: #333; color: #fff; padding: 10px 15px; border-radius: 12px; min-width: 140px; }
        .call-icon-box { width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .call-info { display: flex; flex-direction: column; }
        .call-status { font-size: 16px; font-weight: 900; }
        .call-dur { font-size: 14px; opacity: 0.7; }

        .chat-input-bar {
            flex-shrink: 0;
            background: #fff; border-top: 2px solid var(--line-color);
            padding: 10px 10px 20px 10px; display: flex; align-items: center; gap: 8px; z-index: 50; width: 100%; box-sizing: border-box;
            position: absolute; bottom: 0; left: 0;
        }
        .input-btn { width: 32px; height: 32px; flex-shrink: 0; border: 2px solid var(--line-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #333; cursor: pointer; }
        .input-field { flex: 1; min-width: 0; height: 36px; border: 2px solid var(--line-color); border-radius: 20px; padding: 0 12px; font-size: 14px; background: #f9f9f9; outline: none; }
        .send-btn { background: var(--line-color); color: #fff; border: none; }

        /* ========== TAB 4: RENT ========== */
        /* Scoped to avoid conflicts */
        .page-rent-container { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }
        .rent-select-view { width: 100%; height: 100%; display: flex; flex-direction: column; }

        .rent-header { padding: 20px 15px; border-bottom: 3px solid var(--line-color); background: #fff; margin-bottom: 15px; }
        .rent-big-title { font-family: 'Oswald', sans-serif; font-size: 32px; font-weight: 900; line-height: 1; margin-bottom: 5px; }
        .rent-sub-title { font-family: 'Noto Sans SC', sans-serif; font-size: 14px; font-weight: 700; background: #000; color: #fff; display: inline-block; padding: 2px 6px; }

        .rent-archive-list { padding: 0 15px; display: flex; flex-direction: column; gap: 20px; flex: 1; overflow-y: auto; }
        .rent-banner { position: relative; width: 100%; aspect-ratio: 1200 / 420; background: #e0e0e0; border: 3px solid var(--line-color); box-shadow: var(--shadow-hard); cursor: pointer; overflow: hidden; transition: all 0.2s ease; display: flex; align-items: flex-end; }
        .rent-banner:hover { transform: translateY(-3px); box-shadow: 6px 6px 0 var(--line-color); }
        .rent-banner-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
        .rent-banner-overlay { position: relative; z-index: 1; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 40px 15px 15px 15px; color: #fff; display: flex; justify-content: space-between; align-items: flex-end; }

        /* Removed Rent Profile View (Overlay) from old location to avoid duplicates */

        .rent-top-nav { position: relative; width: 100%; height: 60px; background: var(--line-color); z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: #fff; flex-shrink: 0; }
        .rent-time-strip { width: 100%; display: flex; justify-content: center; gap: 10px; font-family: 'Oswald', sans-serif; font-size: 16px; letter-spacing: 2px; opacity: 0.6; padding: 10px 0; background: transparent; z-index: 5; color: var(--line-color); border-bottom: 1px dashed #ccc; }

        .rent-hero-section { width: 100%; height: 240px; background: #333; position: relative; border-bottom: 3px solid var(--line-color); }
        .rent-hero-img { width: 100%; height: 100%; object-fit: cover; background: #000; opacity: 0.9; }

        .rent-profile-body { padding: 0 15px; position: relative; z-index: 5; }
        .rent-avatar-row { margin-top: -80px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; position: relative; }
        .rent-avatar { width: 90px; height: 90px; border: 3px solid var(--card-white); outline: 3px solid var(--line-color); background: #fff; object-fit: cover; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); z-index: 10; transform: translate(15px, 30px); }
        .rent-book-btn { background: var(--accent-pink); color: #fff; padding: 8px 20px; font-weight: 900; font-family: 'Oswald', sans-serif; border: 2.5px solid var(--line-color); cursor: pointer; box-shadow: 4px 4px 0 var(--line-color); transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; font-size: 14px; margin-top: 60px; }

        .rent-info-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px; }
        .rent-info-box { background: var(--card-white); border: 2px solid var(--line-color); padding: 8px 4px; text-align: center; box-shadow: 3px 3px 0 rgba(0,0,0,0.05); }
        .rent-info-box .info-label { font-size: 12px; font-weight: 700; color: #666; margin-bottom: 2px; }
        .rent-info-box .info-val { font-size: 15px; font-weight: 900; }

        .rent-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .rent-tab-item { flex: 1; text-align: center; padding: 8px 0; font-weight: 800; font-size: 16px; cursor: pointer; border: 2px solid var(--line-color); background: #fff; transition: 0.2s; box-shadow: 3px 3px 0 #ddd; }
        .rent-tab-item.active { background: var(--line-color); color: #fff; transform: translate(2px, 2px); box-shadow: none; }

        .rent-tab-content { display: none; animation: fadeIn 0.3s ease; }
        .rent-tab-content.active { display: block; }

        /* Rent Content Boxes */
        .rent-section-box { background: #fff; border: 2px solid var(--line-color); padding: 15px; margin-bottom: 15px; box-shadow: 4px 4px 0 var(--accent-yellow); position: relative; }
        .rent-section-box::after { content: ''; position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background: var(--line-color); border-radius: 50%; }
        .rent-section-title { font-weight: 900; font-size: 14px; margin-bottom: 10px; display: inline-block; background: #000; color: #fff; padding: 3px 8px; font-family: 'Oswald', sans-serif; letter-spacing: 1px; }

        /* Rent Profile Scroll Area */
        .profile-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; padding-bottom: 40px; }

        /* Rent Profile Header Info */
        .p-name-block { text-align: center; margin-bottom: 15px; margin-top: 5px; }
        .p-name { font-family: 'Oswald', sans-serif; font-size: 24px; font-weight: 900; line-height: 1.2; text-transform: uppercase; }
        .p-meta { font-size: 14px; font-weight: 700; color: #666; background: #eee; display: inline-block; padding: 2px 8px; border-radius: 10px; margin-top: 4px; }

        .copyright {
            text-align: center; font-size: 20px; color: #999;
            padding: 30px 0; margin-top: auto;
            position: relative; bottom: 0;
        }

        /* Tag Cloud */
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }

        /* Feed Items */
        .feed-item { background: #fff; border: 2px solid var(--line-color); margin-bottom: 10px; padding: 10px; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer; }
        .feed-item:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        .f-top { display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 6px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .f-date { color: #999; font-size: 14px; }
        .f-content { font-size: 16px; line-height: 1.4; margin-bottom: 8px; color: #333; }
        .f-footer { display: flex; gap: 15px; font-size: 14px; color: #666; font-weight: 700; }
        .f-act i { margin-right: 4px; }

        /* Review Items - Updated to Card Style */
        .review-item { background: #fff; border: 2px solid var(--line-color); padding: 10px; margin-bottom: 10px; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; }
        .review-item:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        .r-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .r-user { font-weight: 900; font-size: 14px; color: #333; }
        .r-rating { color: var(--accent-yellow); font-size: 14px; letter-spacing: 1px; }
        .r-text { font-size: 14px; color: #666; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

    /* Music Player Styles */
        .player-progress-bg {
            flex: 1;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
            cursor: pointer; /* Make it clickable */
        }

        .player-progress-fill {
            width: 0%;
            height: 100%;
            background: #000;
            transition: width 0.1s linear;
        }

        .page-AYANE .player-progress-fill { background: var(--ayane-color); }
        .page-detail .player-bar i { font-size: 18px; width: 20px; text-align: center; }

        /* Hide old player elements */
        .player-separator, .player-label, .player-sample-text, .player-progress-bar { display: none !important; }

        /* Detail Popup Content */
        .detail-scroll { padding: 15px; overflow-y: auto; flex: 1; }
        .detail-main-box { background: #fff; border: 2px solid var(--line-color); padding: 15px; margin-bottom: 15px; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }
        .d-content { font-size: 14px; line-height: 1.6; color: #333; margin: 10px 0; white-space: pre-wrap; }
        .d-meta { font-size: 14px; color: #999; text-align: right; margin-top: 10px; font-weight: 700; }

        .reply-box { background: #f9f9f9; border-left: 3px solid var(--accent-yellow); padding: 10px; margin-top: 15px; font-size: 16px; color: #555; }
        .reply-label { font-weight: 900; color: #000; margin-bottom: 4px; display: block; font-size: 14px; }

        .comment-list { margin-top: 20px; border-top: 2px solid #eee; padding-top: 10px; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 10px; font-size: 16px; }
        .c-user { font-weight: 900; min-width: 60px; color: #444; }
        .c-text { color: #666; flex: 1; }

        /* Rent Detail Overlay (Feed/Review details) */
        .rent-detail-popup { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 300; backdrop-filter: blur(2px); display: none; justify-content: center; align-items: center; }
        .rent-detail-popup.active { display: flex; animation: fadeIn 0.2s; }
        .rent-popup-card { width: 90%; height: 80%; background: var(--bg-color); border: 3px solid var(--line-color); display: flex; flex-direction: column; box-shadow: 8px 8px 0 var(--line-color); overflow: hidden; animation: popUp 0.3s; }

        /* ========== GLOBAL DOCK ========== */
        .dock-nav {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            width: 85%; height: 60px; flex-shrink: 0;
            background: #000; border-radius: 16px;
            display: flex; justify-content: space-around; align-items: center;
            border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            z-index: 90;
        }
        .nav-btn { color: #666; font-size: 24px; position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; height: 100%; justify-content: center; width: 25%; }
        .nav-btn.active { color: #fff; }
        .nav-btn.active::after { content: ''; position: absolute; bottom: 8px; width: 4px; height: 4px; background: #fff; border-radius: 50%; }
        .nav-dot {
            position: absolute; top: 8px; right: 20%; width: 14px; height: 14px;
            background: var(--badge-red); border-radius: 50%; border: 2px solid #fff;
            display: none; box-shadow: 0 0 8px var(--badge-red);
            animation: dot-pulse 1.5s infinite;
        }
        .nav-dot.visible { display: block; }

        /* ========== FULLSCREEN OVERLAYS (TAB 1 DETAILS) ========== */
        .page-detail {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; overflow: hidden; z-index: 200;
            display: none; flex-direction: column;
            animation: slideUp 0.3s;
        }
        .page-detail.active { display: flex; }
        .page-detail.closing { display: flex; animation: slideDown 0.3s forwards; }

        /* Rent Profile View (Overlay) */
        .rent-profile-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 200; display: none; flex-direction: column; animation: slideUp 0.3s; }
        .rent-profile-overlay.active { display: flex; }
        .rent-profile-overlay.closing { display: flex; animation: slideDown 0.3s forwards; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }

        /* Hide dock when overlay is active (managed by JS class on parent) */
        .hide-dock .dock-nav { display: none !important; }
        .detail-top-nav { position: absolute; top: 0; left: 0; width: 100%; height: 10%; background: var(--line-color); z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: #fff; }
        .detail-time-strip { position: absolute; top: 10%; left: 0; width: 100%; display: flex; justify-content: center; gap: 10px; font-family: 'Oswald', sans-serif; font-size: 16px; letter-spacing: 2px; opacity: 0.6; z-index: 5; }
        .char-container {
            position: absolute; width: 50%; left: 25%; height: 100%; top: 2%;
            display: grid; place-items: end center; /* Stack images */
            z-index: 10; pointer-events: none;
        }
        .page-detail .char-img {
            grid-area: 1 / 1; /* Ensure they stack */
            height: 100%; width: auto; max-width: 100%;
            filter: drop-shadow(8px 8px 0px rgba(0,0,0,0.1));
            animation: breathe 4s ease-in-out infinite;
            transform-origin: bottom center;
            object-fit: contain;
            opacity: 0; transition: opacity 0.3s ease; /* Fade effect */
            /* 默认变量 */
            --off-x: 0%;
            --off-y: 0%;
            --scale: 1;
            --rotate: 0deg;
        }
        .char-img.active { opacity: 1; }
        @keyframes breathe {
            0% { transform: translateX(var(--off-x)) translateY(var(--off-y)) scale(var(--scale)) rotate(var(--rotate)); }
            50% { transform: translateX(var(--off-x)) translateY(calc(var(--off-y) + 5px)) scale(calc(var(--scale) * 1.02)) rotate(var(--rotate)); }
            100% { transform: translateX(var(--off-x)) translateY(var(--off-y)) scale(var(--scale)) rotate(var(--rotate)); }
        }

        .sticker { position: absolute; background: var(--card-white); border: 2.5px solid var(--line-color); border-radius: 12px; box-shadow: var(--shadow-hard); z-index: 20; color: var(--line-color); transition: transform 0.2s ease; }
        .sticker:not(.switch-box):hover { transform: scale(1.05); }
        .stage-box { top: 20%; left: 4%; padding: 8px 12px; border-radius: 4px; animation: float-scaled 5s ease-in-out infinite; transform: scale(0.9); transform-origin: top left; }
        .switch-box { top: 20%; right: 4%; padding: 8px 12px; display: flex; flex-direction: column; gap: 8px; border-radius: 8px; animation: float-scaled 6s ease-in-out infinite 1s; transform: scale(0.9); transform-origin: top right; cursor: pointer; }
        .switch-box.shake { animation: shake-hard 0.4s ease-in-out; }
        @keyframes shake-hard { 0%, 100% { transform: translateX(0) scale(0.9); } 25% { transform: translateX(-5px) scale(0.9); } 75% { transform: translateX(5px) scale(0.9); } }
        .switch-row { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 700; }
        .toggle { width: 40px; height: 20px; border: 2px solid #000; border-radius: 20px; position: relative; }
        .toggle-dot { width: 12px; height: 12px; background: #000; border-radius: 50%; position: absolute; top: 2px; left: 2px; }
        .toggle.on { background: var(--line-color); }
        .toggle.on .toggle-dot { left: auto; right: 2px; background: #fff; }
        .avatar-card { top: 38%; right: 4%; width: 20%; padding: 8px 8px 18px 8px; z-index: 15; text-align: center; background: #fff; border-radius: 4px; animation: float-rotate 5s ease-in-out infinite; }
        .avatar-frame { width: 100%; aspect-ratio: 1/1; background: #eee; border: 2px solid #000; overflow: hidden; margin-bottom: 5px; }
        .avatar-tag { font-size: 12px; font-weight: 900; background: #000; color: #fff; padding: 4px 0; }
        .status-wrapper { position: absolute; top: 55%; left: 6%; width: 40%; z-index: 25; transform: translateY(-50%) scale(0.7); transform-origin: left center; }
        .status-panel { position: relative; background: #fff; border: 3px solid #000; border-radius: 12px; padding: 10px; box-shadow: 4px 4px 0 rgba(0,0,0,1); }
        .cat-sticker, .pixel-ghost { position: absolute; top: -35px; right: -15px; width: 60px; z-index: 30; filter: drop-shadow(2px 2px 0 #fff); animation: cat-bounce 3s infinite ease-in-out; }
        @keyframes cat-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(3px); } }
        .stat-item { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
        .stat-head { display: flex; justify-content: space-between; font-size: 16px; font-weight: 900; }
        .progress-box { height: 12px; border: 2px solid #000; border-radius: 8px; background: #eee; position: relative; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--line-color); }
        .icon-row { display: flex; justify-content: space-between; border-top: 2px dashed #ddd; padding-top: 8px; }
        .icon-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 14px; font-weight: 700; color: #888; transition: transform 0.2s ease; }
        .icon-circle { width: 32px; height: 32px; border: 2px solid #aaa; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s ease; }
        .fake-barcode { position: absolute; bottom: 25%; left: -2%; width: 25%; height: 5%; background: repeating-linear-gradient(90deg, #000, #000 2px, transparent 2px, transparent 4px, #000 6px); transform: rotate(90deg); z-index: 5; opacity: 0.7; }
        .star-deco { position: absolute; color: var(--line-color); z-index: 5; font-size: 24px; animation: star-blink 2s infinite; }
        .star-1 { top: 25%; left: 20%; font-size: 30px; }
        .star-2 { top: 60%; right: 10%; }
        .star-3 { bottom: 20%; right: 8%; font-size: 14px; }
        @keyframes star-blink { 50% { opacity: 0.3; transform: scale(0.8); } }
        .tags-group { position: absolute; bottom: 20%; right: 6%; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; z-index: 15; transform: scale(0.85); transform-origin: bottom right; }
        .tag-item { background: #fff; border: 2px solid #000; padding: 6px 14px; border-radius: 20px; font-size: 14px; font-weight: 900; box-shadow: 2px 2px 0 #ccc; transform: rotate(-2deg); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .tag-item:hover { transform: rotate(0deg) scale(1.05); box-shadow: 3px 3px 0 #999; }
        .location-pill { background: #000; color: #fff; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .bottom-area { position: absolute; bottom: 0; left: 0; width: 100%; height: 20%; background: linear-gradient(to top, #fff 90%, transparent); padding: 0 20px; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 20px; z-index: 30; }
        .name-wrapper { display: flex; align-items: flex-end; margin-bottom: 8px; }
        .name-en { font-family: 'Oswald', sans-serif; font-size: 56px; line-height: 0.8; color: #000; font-weight: 700; font-style: italic; margin-right: 15px; }
        .name-cn-tag { background: #000; color: #fff; font-size: 16px; font-weight: bold; padding: 4px 10px; margin-bottom: 8px; transform: skewX(-10deg); }
        .disclaimer-text { font-size: 14px; color: #666; line-height: 1.2; margin-bottom: 10px; font-family: monospace; max-width: 90%; }
        .player-bar { width: 100%; height: 50px; border: 3px solid #000; border-radius: 30px; display: flex; align-items: center; padding: 0 20px; background: #fff; box-shadow: 4px 4px 0 #000; justify-content: space-between; transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; }
        .player-play-icon { font-size: 16px; color: var(--accent-purple); }
        .player-progress-bar { flex: 1; height: 2px; background: var(--purple-dark); margin: 0 10px; opacity: 0.2; }
        .player-sample-text { font-size: 16px; font-weight: 900; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        @keyframes float-scaled { 0%, 100% { transform: translateY(0) scale(0.9); } 50% { transform: translateY(-4px) scale(0.9); } }
        @keyframes float-rotate { 0%, 100% { transform: translateY(0) rotate(5deg); } 50% { transform: translateY(-4px) rotate(3deg); } }

        /* ==========================================================================
           CHARACTER SPRITE ADJUSTMENTS (MOBILE & DESKTOP)
           ========================================================================== */

        /* --- 1. ERINA (绘里奈) --- */

        /* Unified Desktop Style */
        .page-erina .char-img-business {
            --off-x: -3%;
            --off-y: 60%;
            --rotate: 0deg;
            --scale: 1.7;
            height: 105%;
        }
        /* Unified Desktop Style */
        .page-erina .char-img-private {
            --off-x: 0%;
            --off-y: 45%;
            --rotate: 0deg;
            --scale: 1.5;
            height: 105%;
        }

        /* Desktop Override (Inside Media Query at bottom of file) -> See .page-erina .char-img-business / .char-img-private */


        /* --- 2. AYANE (月宫绾音) --- */

        /* Unified Desktop Style */
        .page-AYANE .char-img-business {
            --off-x: 0%;
            --off-y: 82%;
            --rotate: 0deg;
            --scale: 1.9;
            height: 140%;
            filter: drop-shadow(8px 8px 0px rgba(184,134,11,0.2));
            animation: breathe 5s ease-in-out infinite;
        }
        /* Unified Desktop Style */
        .page-AYANE .char-img-private {
            --off-x: -3%;
            --off-y: 82%;
            --rotate: 0deg;
            --scale: 1.9;
            height: 140%;
            filter: drop-shadow(8px 8px 0px rgba(184,134,11,0.2));
            animation: breathe 5s ease-in-out infinite;
        }

        /* Desktop Override (Inside Media Query at bottom of file) -> See .page-AYANE .char-img in @media block */


        /* --- Other Character Styles --- */
        .page-erina .big-typo-bg { color: #e0e0e0; }
        .page-erina .stage-box { background: var(--erina-color); }
        .page-erina .star-1 { color: var(--erina-color); }
        .page-erina .tag-item:nth-child(2) { transform: rotate(2deg); background: var(--erina-color); }

        .page-AYANE { background-color: #fff9e6; }
        .page-AYANE .bg-grid { background-size: 50px 50px; opacity: 0.03; }
        .page-AYANE .big-typo-bg { color: #fff4d1; }
        .page-AYANE .typo-outline { -webkit-text-stroke: 2px rgba(184, 134, 11, 0.1); color: transparent; }
        .page-AYANE .detail-top-nav { background: var(--ayane-color); color: #000; }
        .page-AYANE .nav-title { color: #000; font-style: italic; font-weight: 900; }

        /* Specific Nav Controls - Enhanced Visibility */
        .nav-back { font-size: 24px; cursor: pointer; padding: 10px; font-weight: 900; transition: transform 0.2s; }
        .nav-back:hover { transform: scale(1.2); }
        .nav-title { font-family: 'Oswald', sans-serif; font-size: 22px; letter-spacing: 1px; font-weight: 700; text-transform: uppercase; }
        .page-AYANE .detail-time-strip { color: #b8860b; opacity: 0.8; }

        /* ...Rest of Character Specific Styles... */
        .page-AYANE .stage-box { background: var(--accent-cyan); }
        .page-AYANE .toggle { border-color: #b8860b; }
        .page-AYANE .toggle-dot { background: #b8860b; }
        .page-AYANE .toggle.on .toggle-dot { background: var(--ayane-color); }
        .page-AYANE .avatar-card { transform: rotate(-3deg); }
        .page-AYANE .avatar-frame { background: #fff; }
        .page-AYANE .avatar-tag { background: var(--ayane-color); color: #000; }
        .page-AYANE .status-wrapper { transform: translateY(-50%) scale(0.7); transform-origin: left center; }
        .page-AYANE .status-panel { border-color: #b8860b; box-shadow: 6px 6px 0 #b8860b; }
        .page-AYANE .progress-box { border-color: #b8860b; }
        .page-AYANE .trust-fill { background: var(--accent-purple); }
        .page-AYANE .love-fill { background: var(--ayane-color); }
        .page-AYANE .pixel-ghost { font-size: 30px; width: auto; }
        .page-AYANE .tag-cv { background: var(--accent-cyan); transform: rotate(-1deg); max-width: 160px; white-space: normal; line-height: 1.2; text-align: right; height: auto; }
        .page-AYANE .tag-fans { transform: rotate(2deg); }
        .page-AYANE .tag-secret { background: var(--ayane-color); color: #000; transform: rotate(-3deg); letter-spacing: 1px; }
        .page-AYANE .name-en { color: #b8860b; }
        .page-AYANE .name-cn-tag { background: #000; border: 1px solid #000; color: #fff; }
        .page-AYANE .disclaimer-text { color: #888; animation: glitch 3s infinite; }
        .page-AYANE .player-bar { border-color: #b8860b; box-shadow: 4px 4px 0 #b8860b; }
        .deco-note { position: absolute; z-index: 5; animation: float 3s infinite; }
        .note-1 { top: 20%; left: 15%; font-size: 24px; color: var(--ayane-color); }
        .note-2 { bottom: 250px; right: 40px; font-size: 30px; color: #b8860b; transform: rotate(15deg); }
    /* News Modal */
        .news-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .news-modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .news-card {
            width: 90%; max-width: 500px;
            background: #fff; border: 4px solid #000;
            box-shadow: 10px 10px 0 #000;
            display: flex; flex-direction: column;
            max-height: 80vh;
        }
        .news-header {
            background: var(--accent-yellow);
            padding: 15px; border-bottom: 4px solid #000;
            font-family: 'Oswald', sans-serif; font-size: 24px; font-weight: 900;
            display: flex; justify-content: space-between; align-items: center;
        }
        .news-close-btn { cursor: pointer; font-size: 20px; transition: transform 0.2s; }
        .news-close-btn:hover { transform: scale(1.2); }
        .news-body { padding: 20px; overflow-y: auto; }
        .news-item-row { border-bottom: 2px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .news-source { background: #000; color: #fff; font-size: 14px; padding: 2px 6px; display: inline-block; margin-bottom: 4px; transform: skewX(-10deg); }
        .news-title { font-weight: 900; font-size: 16px; line-height: 1.4; }

        /* Banner New Badge */
        .banner-new-badge {
            position: absolute; top: 10px; right: 10px;
            background: var(--badge-red); color: #fff;
            font-size: 14px; font-weight: 900; padding: 2px 8px;
            border-radius: 4px; border: 2px solid #fff;
            transform: rotate(15deg);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            z-index: 10; animation: bounce 2s infinite;
        }

        @keyframes dot-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: scale(1.5); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</head>
<body>

    <div class="page-container">
        <!-- Debug Indicator -->
        <div id="debug-indicator" class="debug-indicator">DEBUG MODE: USING MOCK DATA</div>
        <div class="bg-grid"></div>

        <!-- GLOBAL HEADER (Visible for Tabs 1, 2, 3, 4) -->
        <div class="header-group">
            <header class="sys-header">
                <div><i class="fas fa-database"></i> 新宿拯救计划</div>
                <div><i class="fas fa-wifi"></i><i class="fas fa-battery-full" style="margin-left: 20px;"></i></div>
            </header>

            <div class="world-info-bar">
                <div id="world-date">载入中...</div>
                <div><i class="fas fa-map-marker-alt world-blink"></i> <span id="world-location">...</span></div>
            </div>

            <div class="marquee-container" id="news-marquee">
                <div class="marquee-content">
                     ⚠ 警告：检测到非法私联行为,请遵守《租借法》 // ✨ 新人推荐：月宫绾音人气飙升中！ // ⭐ 系统公告：好感度算法已更新 v4.2...
                </div>
            </div>
        </div>

        <div class="content-area">
            <!-- TAB 1: HOME -->
            <div id="tab-content-home" class="tab-content active">
                <div class="hero-banner">
                    <div class="hero-left">
                        <div class="hero-title">ACCESS<br>YOUR<br>DESTINY</div>
                        <div class="hero-sub">/// 24H EMOTIONAL SUPPORT</div>
                    </div>
                    <div class="hero-right">
                        <div class="logo-main">Tomorrows<br><span class="logo-highlight">Girlfriend</span></div>
                        <div class="since-tag">EST. 2026 TOKYO</div>
                    </div>
                </div>

                <div class="archive-list" id="home-archive-list">
                    <!-- Dynamic Character Cards will be inserted here -->
                </div>
            </div>

            <!-- TAB 2: MIND SCAN -->
            <div id="tab-content-mind" class="tab-content">
                <div class="mind-header">
                    <div class="mind-title"><i class="fas fa-brain"></i> 女友心声 <span class="blink">窥听中</span></div>
                    <div class="mind-subtitle"></div>
                </div>
                <div class="mind-list" id="mind-scan-list">
                    <!-- Dynamic Mind Cards will be inserted here -->
                </div>
            </div>

            <!-- TAB 3: CHAT -->
            <div id="tab-content-chat" class="tab-content">
                <div class="chat-view-container">
                    <div class="chat-list-view" id="chat-list-view">
                        <div class="chat-header">
                            <div class="brand-title">TOMORROW'S GIRLFRIEND <span id="total-unread" class="total-badge">0</span></div>
                            <div class="header-btn"><i class="fas fa-search"></i></div>
                        </div>
                        <div class="chat-list" id="chat-list-container">
                            <!-- Items will be generated by 渲染数据() -->
                        </div>
                    </div>
                    <div class="chat-detail-view" id="chat-detail-view">
                        <div class="chat-header">
                            <div class="header-btn" onclick="closeChat()"><i class="fas fa-chevron-left"></i></div>
                            <div class="detail-header-info"><img src="https://files.catbox.moe/byn7zx.png" id="chat-header-avatar" class="header-avatar" alt="聊天头像"><span class="header-name" id="chat-header-name">NAME</span></div>
                            <div class="header-btn"><i class="fas fa-bars"></i></div>
                        </div>
                        <div class="chat-history" id="chat-box"></div>
                        <div class="chat-input-bar">
                            <div class="input-btn"><i class="fas fa-plus"></i></div>
                            <input type="text" class="input-field" placeholder="Type message...">
                            <div class="input-btn send-btn"><i class="fas fa-paper-plane"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 4: RENT -->
            <div id="tab-content-rent" class="tab-content">
                <div class="page-rent-container">
                    <div class="rent-select-view">
                        <div class="rent-header">
                            <div class="rent-big-title">ARCHIVES</div>
                            <div class="rent-sub-title">/// SELECT YOUR TARGET</div>
                        </div>
                        <div class="rent-archive-list" id="rent-banners-container">
                            <!-- Dynamic Rent Banners will be inserted here -->
                        </div>
                        <div class="copyright"> © 2026 Tomorrow's Girlfriend Inc.</div>
                    </div>
                </div>
            </div>

            <!-- ========== OVERLAYS: HOME DETAILS (INSIDE) ========== -->
            <div class="page-detail page-erina" id="page-erina">
                <div class="big-typo-bg"><span class="typo-gray">ERINA</span><span class="typo-stroke">01</span></div>
                <div class="detail-time-strip" id="music-strip-erina"><span>♪ NOW PLAYING</span><span class="track-name">STOPPED</span><span>♪</span></div>
                <div class="fake-barcode"></div>
                <div class="star-deco star-1">✦</div><div class="star-deco star-2">✦</div><div class="star-deco star-3">✱</div>
                <div class="detail-top-nav"><i class="fas fa-chevron-left nav-back" onclick="closePageDetail('erina')"></i><div class="nav-title">TomorrowsGirlfriend</div><i class="fas fa-ellipsis-h"></i></div>
                <div class="char-container">
                    <img src="https://esvigan.cn/绘里奈外.webp" class="char-img char-img-business active">
                    <img src="https://esvigan.cn/绘里奈里.webp" class="char-img char-img-private">
                </div>
                <div class="status-wrapper"><img src="https://i.postimg.cc/gjhvZyjq/d1c66fd6-0733-4a74-bedb-bd5ed27dbc99.png" class="cat-sticker"><div class="status-panel"><div class="stat-item"><div class="stat-head"><span>好感度</span> <span id="erina-detail-love-text">0/400</span></div><div class="progress-box"><div class="progress-fill" id="erina-detail-love-bar"></div></div></div><div class="stat-item"><div class="stat-head"><span>信赖度</span> <span id="erina-detail-trust-text">0/400</span></div><div class="progress-box"><div class="progress-fill" id="erina-detail-trust-bar"></div></div></div><div class="icon-row"><div class="icon-btn"><div class="icon-circle" id="erina-contact-icon"><i class="fas fa-lock"></i></div><span id="erina-contact-text">未交换</span></div><div class="icon-btn"><div class="icon-circle" id="erina-love-icon"><i class="fas fa-heart-broken"></i></div><span id="erina-love-status-text">单身</span></div></div></div></div>
                <div class="sticker stage-box"><div class="stage-label">CURRENT STATUS</div><div class="stage-val"><i class="fas fa-exclamation-triangle"></i> <span id="erina-stage-text">...</span></div></div>
                <div class="sticker switch-box" onclick="toggleMode('erina')">
                    <div class="switch-row"><div class="toggle" id="erina-toggle-private"><div class="toggle-dot"></div></div><span>私生活 OFF</span></div>
                    <div class="switch-row"><div class="toggle on" id="erina-toggle-business"><div class="toggle-dot"></div></div><span>营业中 ON</span></div>
                </div>
                <div class="sticker avatar-card"><div class="avatar-frame"><img src="https://esvigan.cn/绘里奈头像new.webp" class="avatar-img" alt="如月绘里奈头像"></div><div class="avatar-tag"># ID PHOTO</div></div>
                <div class="tags-group"><div class="tag-item"># S级女友</div><div class="tag-item"># 完美演技</div><div class="location-pill"><i class="fas fa-heart"></i> <span id="erina-location-text">专属天使</span></div></div>
                <div class="pregnancy-badge" id="erina-pregnancy-badge" onclick="this.classList.toggle('flipped')">
                    <div class="pregnancy-inner">
                        <div class="pregnancy-front">
                            <i class="fas fa-baby pregnancy-icon"></i>
                            <span class="pregnancy-text">已受孕</span>
                        </div>
                        <div class="pregnancy-back">
                            <i class="fas fa-calendar-alt pregnancy-icon"></i>
                            <span class="pregnancy-text" id="erina-pregnancy-date">2026-02-02</span>
                        </div>
                    </div>
                </div>
                <div class="bottom-area">
                    <div class="name-wrapper"><div class="name-en">KISARAGI</div><div class="name-cn-tag">如月绘里奈</div></div><div class="disclaimer-text"></div>
                    <div class="player-bar" onclick="window.musicManager.toggle('erina')">
                        <i class="fas fa-play player-icon" id="btn-erina"></i>
                        <div class="player-progress-bg" onclick="event.stopPropagation(); window.musicManager.seek(event, 'erina')">
                            <div class="player-progress-fill" id="bar-erina"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-detail page-AYANE" id="page-AYANE">
                <div class="big-typo-bg"><span class="typo-outline">AYANE</span><span class="typo-tsukimiya">Tsukimiya</span></div>
                <div class="detail-time-strip" id="music-strip-AYANE"><span>♪ NOW PLAYING</span><span class="track-name">STOPPED</span><span>♪</span></div>
                <div class="deco-note note-1">♪</div><div class="deco-note note-2">♫</div>
                <div class="detail-top-nav"><i class="fas fa-chevron-left nav-back" onclick="closePageDetail('AYANE')"></i><div class="nav-title">TomorrowsGirlfriend</div><i class="fas fa-ellipsis-h"></i></div>
                <div class="char-container">
                    <img src="https://esvigan.cn/绾音外.webp" class="char-img char-img-business active">
                    <img src="https://esvigan.cn/绾音里.webp" class="char-img char-img-private" alt="月宫绾音私服形象">
                </div>
                <div class="status-wrapper"><div class="pixel-ghost">👻</div><div class="status-panel"><div class="stat-item"><div class="stat-head"><span>好感度</span> <span id="AYANE-detail-love-text">0/400</span></div><div class="progress-box"><div class="progress-fill love-fill" id="AYANE-detail-love-bar"></div></div></div><div class="stat-item"><div class="stat-head trust-head"><span>信赖度</span> <span id="AYANE-detail-trust-text">0/400</span></div><div class="progress-box"><div class="progress-fill trust-fill" id="AYANE-detail-trust-bar"></div></div></div><div class="icon-row"><div class="icon-btn"><div class="icon-circle" id="AYANE-contact-icon"><i class="fas fa-lock"></i></div><span id="AYANE-contact-text">未交换</span></div><div class="icon-btn"><div class="icon-circle" id="AYANE-love-icon"><i class="fas fa-heart-broken"></i></div><span id="AYANE-love-status-text">单身</span></div></div></div></div>
                <div class="sticker stage-box"><div class="stage-label">CURRENT STATUS</div><div class="stage-val"><i class="fas fa-robot"></i> <span id="AYANE-stage-text">...</span></div></div>
                <div class="sticker switch-box" onclick="toggleMode('AYANE')">
                    <div class="switch-row"><div class="toggle" id="AYANE-toggle-private"><div class="toggle-dot"></div></div><span>私生活 OFF</span></div>
                    <div class="switch-row"><div class="toggle on" id="AYANE-toggle-business"><div class="toggle-dot"></div></div><span>营业中 ON</span></div>
                </div>
                <div class="sticker avatar-card"><div class="avatar-frame"><img src="https://esvigan.cn/林绛头像new.webp" class="avatar-img" alt="月宫绾音头像"></div><div class="avatar-tag" id="AYANE-name-tag"># ID PHOTO

                </div></div>
                <div class="tags-group"><div class="tag-item tag-cv"><i class="fas fa-microphone-alt"></i> <span id="AYANE-cv-text">CV学习: 基础阶段</span></div><div class="tag-item tag-fans"><i class="fas fa-users"></i> <span id="AYANE-fans-text">粉丝数: 0人</span></div><div class="tag-item tag-secret" id="AYANE-secret-text">REAL NAME: ???</div></div>
                <div class="pregnancy-badge" id="AYANE-pregnancy-badge" onclick="this.classList.toggle('flipped')">
                    <div class="pregnancy-inner">
                        <div class="pregnancy-front">
                            <i class="fas fa-baby pregnancy-icon"></i>
                            <span class="pregnancy-text">已受孕</span>
                        </div>
                        <div class="pregnancy-back">
                            <i class="fas fa-calendar-alt pregnancy-icon"></i>
                            <span class="pregnancy-text" id="AYANE-pregnancy-date">2026-02-02</span>
                        </div>
                    </div>
                </div>
                <div class="bottom-area">
                    <div class="name-wrapper"><div class="name-en">AYANE</div><div class="name-cn-tag">月宫绾音</div></div><div class="disclaimer-text glitch-text"></div>
                    <div class="player-bar" onclick="window.musicManager.toggle('AYANE')">
                        <i class="fas fa-play player-play-icon" id="btn-AYANE"></i>
                        <div class="player-progress-bg" onclick="event.stopPropagation(); window.musicManager.seek(event, 'AYANE')">
                            <div class="player-progress-fill" id="bar-AYANE"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== OVERLAYS: RENT DETAILS (INSIDE) ========== -->
            <div class="rent-profile-overlay" id="rent-profile-overlay">
                <div class="rent-top-nav"><i class="fas fa-chevron-left nav-back" onclick="closeRentProfile()"></i><div class="nav-title">TomorrowsGirlfriend</div><i class="fas fa-ellipsis-h"></i></div>
                <div class="rent-time-strip"><i class="fas fa-crosshairs"></i><span id="p-time-strip">租借女友详情</span><i class="fas fa-crosshairs"></i></div>
                <div class="profile-scroll">
                    <div class="rent-hero-section"><img id="p-hero" class="rent-hero-img" src="" alt="租借女友形象图"></div>
                    <div class="rent-profile-body">
                        <div class="rent-avatar-row"><img id="p-avatar" class="rent-avatar" src="https://files.catbox.moe/byn7zx.png"><button type="button" class="rent-book-btn">立即预约</button></div>
                        <div class="p-name-block"><div class="p-name" id="p-fullname">姓名</div><div class="p-meta" id="p-tagline">标签</div></div>
                        <div class="rent-info-grid">
                            <div class="rent-info-box"><div class="info-label">时薪</div><div class="info-val" id="p-rate">¥0</div></div>
                            <div class="rent-info-box"><div class="info-label">评分</div><div class="info-val" id="p-rating">5.0</div></div>
                            <div class="rent-info-box"><div class="info-label">年龄</div><div class="info-val" id="p-age">18</div></div>
                            <div class="rent-info-box"><div class="info-label">类型</div><div class="info-val" id="p-type">类型</div></div>
                        </div>
                        <div class="rent-tabs">
                            <div class="rent-tab-item active" onclick="switchRentTab('info')" data-tab="info">档案 & 规则</div>
                            <div class="rent-tab-item" onclick="switchRentTab('feed')" data-tab="feed">最新动态</div>
                            <div class="rent-tab-item" onclick="switchRentTab('reviews')" data-tab="reviews">用户评价</div>
                        </div>
                        <div id="rent-tab-info" class="rent-tab-content active">
                            <div class="rent-section-box"><div class="rent-section-title">个人独白</div><div class="section-text" id="p-bio">...</div></div>
                            <div class="rent-section-box"><div class="rent-section-title">活动范围</div><div class="section-text" id="p-map">...</div><div class="tag-cloud" id="p-map-tags"></div></div>
                            <div class="rent-section-box"><div class="rent-section-title">规则 & 红线</div><div class="section-text" id="p-rules">...</div></div>
                            <div class="rent-section-box"><div class="rent-section-title">接待档期</div><div class="section-text" id="p-schedule">...</div></div>
                        </div>
                        <div id="rent-tab-feed" class="rent-tab-content"><div id="feed-container"></div></div>
                        <div id="rent-tab-reviews" class="rent-tab-content"><div id="reviews-container"></div><div class="reviews-footer">已显示最近 20 条评价</div></div>
                        <div class="spacer-30"></div>
                    </div>
                </div>
            </div>

            <!-- RENT SUB-DETAILS (Feed/Review Popup) -->
            <div id="rent-detail-popup" class="rent-detail-popup" onclick="closeRentDetail(event)">
                <div class="rent-popup-card" onclick="event.stopPropagation()">
                    <div class="rent-top-nav"><div class="nav-back" onclick="closeRentDetail()"><i class="fas fa-times"></i> CLOSE</div><div class="nav-title" id="d-header-title">DETAIL</div><div class="nav-spacer"></div></div>
                    <div class="detail-scroll" id="rent-detail-content-area"></div>
                </div>
            </div>

            <!-- NEWS MODAL -->
            <div class="news-modal-overlay" id="news-modal" onclick="$(this).removeClass('active')">
                <div class="news-card" onclick="event.stopPropagation()">
                    <div class="news-header">
                        <div>NEWS REPORT</div>
                        <div class="news-close-btn" onclick="$('#news-modal').removeClass('active')"><i class="fas fa-times"></i></div>
                    </div>
                    <div class="news-body" id="news-list-container">
                        <!-- News items injected here -->
                    </div>
                </div>
            </div>

        </div> <!-- End Content Area -->





        <!-- GLOBAL DOCK NAV -->
        <nav class="dock-nav">
            <div class="nav-btn active" onclick="switchMainTab(0)" id="nav-btn-0"><i class="fas fa-home"></i></div>
            <div class="nav-btn" onclick="switchMainTab(1)" id="nav-btn-1"><i class="fas fa-compass"></i></div>
            <div class="nav-btn" onclick="switchMainTab(2)" id="nav-btn-2">
                <i class="fas fa-comment-dots"></i>
                <div id="nav-red-dot" class="nav-dot"></div>
            </div>
            <div class="nav-btn" onclick="switchMainTab(3)" id="nav-btn-3">
                <i class="fas fa-user-circle"></i>
                <div id="nav-red-dot-rent" class="nav-dot"></div>
            </div>
        </nav>

    <script>
    /* ========== MUSIC MANAGER ========== */
    (function() {
        const MUSIC_CONFIG = {
            'erina': {
                url: 'https://pub-4f69b26e6f244cc1a03edb0aa827b72b.r2.dev/%E7%AB%B9%E5%86%85%E3%81%BE%E3%82%8A%E3%82%84%20-%20%E3%83%97%E3%83%A9%E3%82%B9%E3%83%86%E3%82%A3%E3%83%83%E3%82%AF%E3%83%BB%E3%83%A9%E3%83%B4.mp3',
                title: '♫ プラスティック・ラヴ'
            },
            'AYANE': {
                url: 'https://pub-4f69b26e6f244cc1a03edb0aa827b72b.r2.dev/%E3%83%A8%E3%83%AB%E3%82%B7%E3%82%AB%20-%20%E3%82%A2%E3%83%AB%E3%82%B8%E3%83%A3%E3%83%BC%E3%83%8E%E3%83%B3.mp3',
                title: '♫ アルジャーノン'
            }
        };

        // Preload Audio to Browser Cache
        try {
            Object.values(MUSIC_CONFIG).forEach(config => {
                const preload = new Audio();
                preload.src = config.url;
                preload.preload = 'auto';
                preload.load();
            });
        } catch(e) {}

        class GlobalMusicPlayer {
            constructor() {
                this.audio = new Audio();
                this.audio.loop = true;
                this.currentId = null;

                this.audio.addEventListener('timeupdate', () => this.updateUI());
                this.audio.addEventListener('play', () => this.updateUI());
                this.audio.addEventListener('pause', () => this.updateUI());
                this.audio.addEventListener('ended', () => this.updateUI());
            }

            play(id) {
                if (this.currentId !== id) {
                    const config = MUSIC_CONFIG[id];
                    if (!config) return;
                    this.audio.src = config.url;
                    this.currentId = id;
                    this.updateTitle(config.title);
                }
                this.audio.play().catch(e => console.error("Play error:", e));
            }

            pause() {
                this.audio.pause();
            }

            toggle(id) {
                if (this.currentId === id && !this.audio.paused) {
                    this.pause();
                } else {
                    this.play(id);
                }
            }

            seek(event, id) {
                if (this.currentId !== id) return;
                const bar = event.currentTarget;
                const rect = bar.getBoundingClientRect();
                const percent = (event.clientX - rect.left) / rect.width;
                if (this.audio.duration) {
                    this.audio.currentTime = this.audio.duration * percent;
                }
            }

            updateTitle(title) {
                ['erina', 'AYANE'].forEach(id => {
                    const strip = document.getElementById(`music-strip-${id}`);
                    if (strip) {
                        const nameSpan = strip.querySelector('.track-name');
                        const cleanTitle = title.replace('♫ ', '');
                        if(nameSpan && nameSpan.textContent !== cleanTitle) {
                            nameSpan.textContent = cleanTitle;
                        }
                    }
                });
            }

            updateUI() {
                // Update Title if DOM refreshed
                if (this.currentId) {
                    const config = MUSIC_CONFIG[this.currentId];
                    if (config) {
                        this.updateTitle(config.title);
                    }
                } else {
                     this.updateTitle('STOPPED');
                }

                const isPlaying = !this.audio.paused;
                const progress = (this.audio.currentTime / this.audio.duration) * 100 || 0;

                // Update all play buttons
                ['erina', 'AYANE'].forEach(id => {
                    const btn = document.getElementById(`btn-${id}`);
                    const bar = document.getElementById(`bar-${id}`);

                    if (btn) {
                        // Preserve base classes but toggle icon
                        const baseClass = 'fas player-icon';
                        if (this.currentId === id && isPlaying) {
                            btn.className = `${baseClass} fa-pause`;
                        } else {
                            btn.className = `${baseClass} fa-play`;
                        }
                    }

                    if (bar) {
                        if (this.currentId === id) {
                            bar.style.width = `${progress}%`;
                        } else {
                            bar.style.width = '0%';
                        }
                    }
                });
            }
        }

        // Singleton Management
        let globalScope = window;
        try {
            if (window.top && window.top !== window) {
                globalScope = window.top;
            } else if (window.parent && window.parent !== window) {
                globalScope = window.parent;
            }
        } catch(e) { }

        const PLAYER_KEY = '_mvu_global_music_player_v2';
        let player = null;

        if (globalScope[PLAYER_KEY]) {
            player = globalScope[PLAYER_KEY];
        } else {
            player = new GlobalMusicPlayer();
            globalScope[PLAYER_KEY] = player;

            // Session Storage Restore
            try {
                const savedState = JSON.parse(sessionStorage.getItem('mvu_music_state'));
                if (savedState && savedState.id && savedState.isPlaying && (Date.now() - savedState.timestamp < 300000)) {
                    const config = MUSIC_CONFIG[savedState.id];
                    if (config) {
                        player.currentId = savedState.id;
                        player.audio.src = config.url;
                        player.audio.currentTime = savedState.time || 0;
                        player.audio.play().catch(e => console.error("Resume error:", e));
                    }
                }
            } catch(e) {}
        }

        window.musicManager = player;

        // --- HOTFIX: OVERWRITE METHODS TO USE CURRENT CONTEXT ---
        player.updateTitle = function(title) {
            ['erina', 'AYANE'].forEach(id => {
                const strip = document.getElementById(`music-strip-${id}`);
                if (strip) {
                    const nameSpan = strip.querySelector('.track-name');
                    const cleanTitle = title.replace('♫ ', '');
                    if(nameSpan && nameSpan.textContent !== cleanTitle) {
                        nameSpan.textContent = cleanTitle;
                    }
                }
            });
        };

        player.updateUI = function() {
            if (this.currentId) {
                const config = MUSIC_CONFIG[this.currentId];
                if (config) {
                    this.updateTitle(config.title);
                }
                // State Saver
                if (!this.audio.paused) {
                    try {
                        sessionStorage.setItem('mvu_music_state', JSON.stringify({
                            id: this.currentId,
                            time: this.audio.currentTime,
                            isPlaying: true,
                            timestamp: Date.now()
                        }));
                    } catch(e) {}
                }
            } else {
                 this.updateTitle('STOPPED');
            }

            const isPlaying = !this.audio.paused;
            const progress = (this.audio.currentTime / this.audio.duration) * 100 || 0;

            ['erina', 'AYANE'].forEach(id => {
                const btn = document.getElementById(`btn-${id}`);
                const bar = document.getElementById(`bar-${id}`);

                if (btn) {
                    const baseClass = 'fas player-icon';
                    if (this.currentId === id && isPlaying) {
                        btn.className = `${baseClass} fa-pause`;
                    } else {
                        btn.className = `${baseClass} fa-play`;
                    }
                }

                if (bar) {
                    if (this.currentId === id) {
                        bar.style.width = `${progress}%`;
                    } else {
                        bar.style.width = '0%';
                    }
                }
            });
        };

        player.play = function(id) {
            if (this.currentId !== id) {
                const config = MUSIC_CONFIG[id];
                if (!config) return;
                this.audio.src = config.url;
                this.currentId = id;
                this.updateTitle(config.title);
            }
            this.audio.play().catch(e => console.error("Play error:", e));
        };

        player.toggle = function(id) {
            if (this.currentId === id && !this.audio.paused) {
                this.pause();
            } else {
                this.play(id);
            }
        };

        player.seek = function(event, id) {
            if (this.currentId !== id) return;
            const bar = event.currentTarget;
            const rect = bar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            if (this.audio.duration) {
                this.audio.currentTime = this.audio.duration * percent;
            }
        };

        // Initial UI Update
        setTimeout(() => window.musicManager.updateUI(), 500);
        // Periodically update UI in case of DOM refresh without full reload
        setInterval(() => window.musicManager.updateUI(), 1000);

    })();
    </script>

    <script>
        // Tavern Macros - These will be replaced by Tavern at load time
        const TAVERN_USER_AVATAR = "{{userAvatarPath}}";
        const TAVERN_CHAR_AVATAR = "{{charAvatarPath}}";

        // ========== DEBUG MODE CONFIG ==========
        const DEBUG_MODE = false; // 设置为 true 则使用下方预设数据，false 则调用酒馆真实变量

        const MOCK_DATA = {
            "世界信息": { "时间": "2026年02月02日星期一 下午 14:30", "地点": "新宿歌舞伎町" },
            "绘里奈": {
                "好感度": 320, "信赖度": 280, "拥有联系方式": true, "关系阶段": "特別への渇望", "恋爱状态": true,
                "心情": "特别开心",
                "$表心声": "今天也要打起精神来哦！", "$里心声": "其实...好想一直待在你身边啊...",
                "受孕状态": true, "受孕日期": "2026-01-25",
                "$消息记录": {
                    "2026-02-02 10:00_01": { "发送者": "绘里奈", "文字内容": "早安！今天也要元气满满！", "类型": "文字消息" },
                    "2026-02-02 10:05_02": { "发送者": "user", "文字内容": "早安绘里奈。", "类型": "文字消息" },
                    "2026-02-02 11:30_03": { "发送者": "绘里奈", "文字内容": "这是我刚才拍的照片哦！", "类型": "图片" },
                    "2026-02-02 12:00_04": { "发送者": "绘里奈", "文字内容": "记得想我哦~", "类型": "语音", "时长": 5 }
                },
                "$社交动态": {
                    "2026-02-02 09:00": { "动态内容": "今天天气真好！", "发布地点": "涩谷", "评论数量": 1, "评论列表": { "user": "确实不错。" } }
                }
            },
            "月宫绾音": {
                "好感度": 150, "信赖度": 120, "拥有联系方式": true, "关系阶段": "朋友界限期", "恋爱状态": true,
                "心情": "平静",
                "透露真名": false, "CV学习进度": "进阶阶段", "粉丝数": 15200,
                "受孕状态": true, "受孕日期": "2026年02月01日",
                "$表心声": "今天的咖啡味道不错。", "$里心声": "总觉得，你和别人不太一样...",
                "$消息记录": {
                    "2026-02-01 22:00_01": { "发送者": "林绛", "文字内容": "晚安。", "类型": "文字消息" },
                    "2026-02-02 09:00_02": { "发送者": "user", "文字内容": "今天有空吗？", "类型": "文字消息" },
                    "2026-02-02 09:15_03": { "发送者": "林绛", "文字内容": "对不起，今天要录音呢。", "类型": "语音", "时长": 12 }
                }
            },
            "$三人群组": {
                "群名": "新宿拯救计划讨论组",
                "消息记录": {
                    "2026-02-02 12:00_01": { "发送者": "绘里奈", "文字内容": "大家中午好呀！", "类型": "文字消息" },
                    "2026-02-02 12:05_02": { "发送者": "林绛", "文字内容": "午好。", "类型": "文字消息" },
                    "2026-02-02 12:10_03": { "发送者": "user", "文字内容": "吃过饭了吗？", "类型": "文字消息" }
                }
            },
            "$新闻速报": {
                "速报列表": {
                    "新闻1": { "来源": "TBS新闻", "标题": "新宿歌舞伎町今晚将加强夜间巡逻", "正文": "由于近期深夜骚乱频发，警视厅决定从今日起在歌舞伎町一番街及周边区域增派警力，重点盘查可疑人员。请各位市民及游客注意安全，随身携带身份证件。" },
                    "新闻2": { "来源": "Yahoo!", "标题": "租借服务市场持续升温", "正文": "最新的市场调查报告显示，'情感陪伴'类服务的需求量在过去一个季度增长了 300%。专家分析认为，现代都市人的孤独感是推动这一产业爆发的主要原因。" },
                    "新闻3": { "来源": "ViVi", "标题": "秋季约会妆容特辑", "正文": "本季最流行的'微醺感'妆容教程大公开！只需三步，就能打造出让男朋友怦然心动的温柔氛围。重点在于腮红的晕染范围和唇釉的水光感哦。" }
                }
            }
        };

        // ========== NAVIGATION LOGIC ==========
        function switchMainTab(index) {
            // Update Tab Content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            if(index === 0) document.getElementById('tab-content-home').classList.add('active');
            if(index === 1) document.getElementById('tab-content-mind').classList.add('active');
            if(index === 2) document.getElementById('tab-content-chat').classList.add('active');
            if(index === 3) document.getElementById('tab-content-rent').classList.add('active');

            // Update Nav Icons
            document.querySelectorAll('.dock-nav .nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-btn-${index}`).classList.add('active');
        }

        /* ========== HOME LOGIC ========== */
        function showPageDetail(pageName) {
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelector('.page-container').classList.add('hide-dock');
        }
        function closePageDetail(pageName) {
            const el = document.getElementById(`page-${pageName}`);
            el.classList.add('closing');
            el.classList.remove('active');
            setTimeout(() => {
                el.classList.remove('closing');
                document.querySelector('.page-container').classList.remove('hide-dock');
            }, 300);
        }

        // ========== MIND SCAN LOGIC ==========
        function flipCard(cardId) {
            const card = document.getElementById(cardId);
            card.classList.toggle('flipped');
            if(navigator.vibrate) navigator.vibrate(20);
        }

        // ========== CONFIGURATION ==========
        const CHARACTER_CONFIG = {
            erina: {
                id: 'erina',
                name: '如月绘里奈',
                fullName: '如月 绘里奈',
                nameEn: 'KISARAGI ERINA',
                avatar: 'https://esvigan.cn/绘里奈头像new.webp',
                hero: 'https://esvigan.cn/绘里奈.webp',
                heroOutside: 'https://esvigan.cn/绘里奈外.webp',
                heroInside: 'https://esvigan.cn/绘里奈里.webp',
                themeClass: 'theme-erina',
                styleClass: 'style-erina',
                color: '#cd84f1',
                rank: 'TOP 1',
                rankIcon: 'fas fa-crown',
                tags: ['完美'],
                varPrefix: '绘里奈',
                rentInfo: {
                    tagline: "S级 | 元气小恶魔 / 活力全开 / 笑容制造机",
                    rate: "¥10,000",
                    rating: "5.0 ★",
                    age: "17",
                    type: "元气少女",
                    bio: "锵锵~！初次见面，我是超级无敌元气的绘里奈！👋✨\n\n在这个总是让人觉得累累的世界里，您一定需要一个像太阳一样的存在吧？不管是工作的烦恼，还是无聊的日常，只要见到绘里奈，保证让您瞬间电力满格！对我来说，您的快乐就是我的头等大事！\n\n“只要能看到您的笑容，绘里奈觉得整个世界都亮起来了哦！”💕🌟",
                    map: "📍 活力街区：涩谷、新宿、原宿（这些地方和绘里奈的风格超搭的！）\n🕹️ 快乐据点：大型电玩城、热闹的游乐园、还有可以尽情欢笑的餐厅\n🍱 推荐路线：先去拍可爱的拍立得，再去吃超火的甜品，最后在晚风里开心地聊天！",
                    mapTags: ["#活力少女", "#绝对治愈", "#笑容满分", "#闪闪发光"],
                    rules: "🤝 关于接触：允许元气满满的牵手、开心的拥抱、以及绘里奈主动的可爱互动。禁止越界行为。\n🧱 关于隐私：绘里奈是只属于约会时间的精灵，请不要试图追踪精灵的去向。记住此刻闪闪发光的我就好啦！\n🎁 奖励机制：如果您能坦率地大声笑出来，绘里奈会送您额外的神秘小惊喜哦！",
                    schedule: "起订时长：2小时起（绘里奈想和您创造更多快乐的回忆嘛~）\n入场费：10,000 円 / hour\n☀️ 专属搭档：想要一起去探店？还是想让我陪您热热闹闹地玩游戏？只要您开口，绘里奈就是您最给力的阳光搭档！"
                }
            },
            AYANE: {
                id: 'AYANE',
                name: '月宫绾音',
                fullName: '月宫 绾音',
                nameEn: 'TSUKIMIYA AYANE',
                avatar: 'https://esvigan.cn/林绛头像new.webp',
                hero: 'https://esvigan.cn/绾音(旧）.webp',
                heroOutside: 'https://esvigan.cn/绾音外.webp',
                heroInside: 'https://esvigan.cn/绾音里.webp',
                themeClass: 'theme-AYANE',
                styleClass: 'style-AYANE',
                color: '#feca57',
                rank: 'TOP 7',
                rankIcon: 'fas fa-caret-up',
                tags: ['偶像', '新人'],
                varPrefix: '月宫绾音',
                rentInfo: {
                    tagline: "新人 | 理想初恋 / 极致温柔 / 细心满分",
                    rate: "¥8,000",
                    rating: "5.0 ★",
                    age: "19",
                    type: "国民级美少女",
                    bio: "您好呀，未来的“男朋友”。初次见面，我是绾音。👋✨\n\n在这个总是让人觉得累累的城市里，您是不是也偶尔渴望一个可以彻底放松、被全心全意宠溺的港湾呢？其实我也有点贪心，希望能独占您的这段时间，和您一起创造只属于我们的回忆。\n\n“只要能看到您的笑容，我就觉得今天的一切都变得有意义了。”💕🌟",
                    map: "📍 浪漫圣地：银座、六本木、能看到绝美霓虹的顶楼餐厅。\n🍹 氛围空间：江边洒满月光的步道、藏在巷弄里的精致甜品店。\n🍱 推荐路线：先在夕阳下牵手散步，然后一起享受晚餐，最后在晚风里交换心事……",
                    mapTags: ["#理想初恋", "#极致温柔", "#氛围感女友", "#细心满分"],
                    rules: "🤝 关于接触：允许心跳加速的牵手、亲昵的挽手、以及根据氛围自然发生的各种温情互动。禁止越界行为。\n🧱 守护面具：绾音是为您而生的理想化身，请不要打探我的真实生活。保持一点点神秘，爱情才会永远保鲜。\n🎁 预约申请：如果您有特别想听的甜言蜜语，或者希望我准备的小惊喜，请详细告诉我。我会为您量身打造心动时刻。",
                    schedule: "心动时薪：8,000 円 / hour\n约会约定：2小时起订（心动的感觉，需要慢慢发酵才更有余韵呢。）\n🎭 角色适配：如果您有特别的幻想（如邻家妹妹、知性姐姐），请务必备注。我会为您献上最沉浸的甜蜜演出。"
                }
            }
        };

        const chatData = {};
        const rentDb = {};
        const lastSeenKeys = {};
        const lastSeenPostsKeys = {};
        const feedLikesCache = {};

        // Manual Override State
        const charViewState = {
            erina: { override: null },
            AYANE: { override: null }
        };

        window.toggleMode = function(charId) {
            const pageEl = document.getElementById(`page-${charId}`);
            // Check if character is strictly in love (using class added by renderer)
            const isInLove = pageEl.classList.contains('is-in-love');

            if (!isInLove) {
                 // Not allowed to switch
                 if(navigator.vibrate) navigator.vibrate(50);

                 // Trigger shake animation
                 const switchBox = document.querySelector(`#page-${charId} .switch-box`);
                 switchBox.classList.remove('shake');
                 void switchBox.offsetWidth; // Force reflow
                 switchBox.classList.add('shake');

                 return;
            }

            // Toggle logic
            const currentOverride = charViewState[charId].override;
            // Note: When isInLove is true, default (null) is 'private'.

            let newMode = 'business';

            // If currently null (default private) OR explicitly private -> switch to business
            if (currentOverride === null || currentOverride === 'private') {
                newMode = 'business';
            } else {
                // If explicitly business -> switch to private
                newMode = 'private';
            }

            // Set override
            charViewState[charId].override = newMode;

            // Force immediate update
            渲染数据();

            // Haptic feedback
            if(navigator.vibrate) navigator.vibrate(20);
        };

        function initDataStructures() {
            Object.keys(CHARACTER_CONFIG).forEach(id => {
                lastSeenPostsKeys[id] = localStorage.getItem(`lastSeenPosts_${id}`) || '';
            });

            Object.values(CHARACTER_CONFIG).forEach(char => {
                chatData[char.id] = {
                    id: char.id,
                    name: char.name,
                    avatar: char.avatar,
                    styleClass: char.styleClass,
                    messages: [],
                    hasNew: false,
                    lastSeenKey: null
                };
                rentDb[char.id] = {
                    ...char.rentInfo,
                    id: char.id,
                    name: char.id === 'erina' ? 'Erina' : 'Ayane', // Keep short name for internal use
                    fullName: char.fullName,
                    hero: char.hero,
                    avatar: char.avatar,
                    posts: [],
                    reviews: generateReviews(char.id),
                    hasNew: false
                };
                lastSeenKeys[char.id] = localStorage.getItem(`lastSeen_${char.id}`);
            });

            // Add Group Chat
            chatData.group = {
                id: 'group',
                name: '新宿拯救计划讨论组',
                avatar: 'https://esvigan.cn/11.webp',
                styleClass: 'style-group',
                messages: [],
                hasNew: false,
                lastSeenKey: null,
                isGroup: true
            };
            lastSeenKeys.group = localStorage.getItem('lastSeen_group');
        }

        function initDynamicUI() {
            const homeList = document.getElementById('home-archive-list');
            const mindList = document.getElementById('mind-scan-list');
            const rentBanners = document.getElementById('rent-banners-container');

            let homeHtml = '';
            let mindHtml = '';
            let rentHtml = '';

            Object.values(CHARACTER_CONFIG).forEach(char => {
                // Home Card
                homeHtml += `
                    <div class="archive-card card-${char.id}" onclick="showPageDetail('${char.id}')">
                        <div class="card-avatar-box"><img src="${char.avatar}" class="avatar-img char-avatar"></div>
                        <div class="card-info-box">
                            <div class="info-header">
                                <div><div class="name-main">${char.fullName}</div><div class="name-sub">${char.nameEn}</div></div>
                                <div class="rank-badge"><i class="${char.rankIcon}"></i> ${char.rank}</div>
                            </div>
                            <div class="stats-row">
                                <div class="stat-col"><div class="stat-label"><span>LOVE</span><span id="${char.id}-love-text">0/400</span></div><div class="mini-progress"><div class="mini-fill" id="${char.id}-love-bar"></div></div></div>
                                <div class="stat-col"><div class="stat-label"><span>TRUST</span><span id="${char.id}-trust-text">0/400</span></div><div class="mini-progress"><div class="mini-fill" id="${char.id}-trust-bar"></div></div></div>
                            </div>
                            <div class="tags-row">
                                ${char.tags.map(t => `<span class="tag" style="background:${char.color}; ${char.id === 'erina' ? 'color:#fff' : ''}">${t}</span>`).join('')}
                                <span class="tag" id="${char.id}-stage-tag">载入中...</span>
                            </div>
                            <div class="status-strip"><div class="status-light"></div><span id="${char.id}-status-text">...</span></div>
                        </div>
                    </div>`;

                // Mind Card
                mindHtml += `
                    <div class="mind-card ${char.themeClass}" id="card-${char.id}" onclick="flipCard('card-${char.id}')">
                        <div class="card-inner">
                            <div class="card-face face-surface">
                                <div class="card-header-mind"><div class="char-name">${char.fullName}</div><div class="toggle-btn"><i class="fas fa-eye"></i></div></div>
                                <div class="card-body-mind">
                                    <div class="mind-avatar-row"><img src="${char.avatar}" class="mind-avatar char-avatar"><div class="bubble">...</div></div>
                                    <div class="mood-bar-container"><div class="mood-info"><span>MOOD: ...</span></div></div>
                                </div>
                            </div>
                            <div class="card-face face-inner">
                                <div class="card-header-mind"><div class="char-name">${char.id === 'erina' ? "Erina's Diary" : "Ayane's Note"}</div><div class="toggle-btn" onclick="flipCard('card-${char.id}')"><i class="fas fa-heart"></i></div></div>
                                <div class="card-body-mind warm-content">
                                    <div class="cmd-line"><i class="fas fa-bookmark heart-icon"></i> 秘密心声: <span class="soft-pulse">已解锁</span></div>
                                    <div class="inner-text">...</div>
                                </div>
                            </div>
                        </div>
                    </div>`;

                // Rent Banner
                rentHtml += `
                    <div class="rent-banner" onclick="openRentProfile('${char.id}')">
                        <img src="${char.hero}" class="rent-banner-img">
                        <div id="banner-badge-${char.id}" class="banner-new-badge" style="display:none">NEW!</div>
                        <div class="rent-banner-overlay">
                            <div><div class="banner-name-main">${char.fullName}</div><div class="banner-name-sub">${char.nameEn}</div></div>
                            <i class="fas fa-arrow-right banner-icon"></i>
                        </div>
                    </div>`;
            });

            // Add locked card to home
            homeHtml += `
                <div class="archive-card card-locked">
                    <div class="card-avatar-box"><div style="font-size:30px; font-weight:bold;">?</div></div>
                    <div class="card-info-box">
                        <div class="info-header"><div><div class="name-main">UNKNOWN</div><div class="name-sub">DATA NOT FOUND</div></div><div class="rank-badge">LOCKED</div></div>
                        <div class="stats-row" style="opacity:0.3"><div class="stat-col"><div class="mini-progress"></div></div><div class="stat-col"><div class="mini-progress"></div></div></div>
                        <div class="tags-row"><span class="tag">即将登场</span></div>
                        <div class="status-strip"><span>OFFLINE</span></div>
                    </div>
                </div>`;

            homeList.innerHTML = homeHtml;
            mindList.innerHTML = mindHtml;
            rentBanners.innerHTML = rentHtml;
        }

        initDataStructures();
        initDynamicUI();

        // ========== HOME LOGIC ==========

        function updateBadges() {
            try {
                let totalUnreadMessages = 0;
                Object.values(chatData).forEach(char => {
                    if (char.hasNew) totalUnreadMessages++;
                    const badgeEl = document.getElementById(`badge-${char.id}`);
                    if (badgeEl) {
                        badgeEl.innerText = 'N';
                        badgeEl.classList.toggle('hidden', !char.hasNew);
                    }
                });

                let totalUnreadPosts = 0;
                Object.values(rentDb).forEach(char => {
                    if (char.hasNew) totalUnreadPosts++;
                });

                const msgDot = document.getElementById('nav-red-dot');
                if (msgDot) msgDot.classList.toggle('visible', totalUnreadMessages > 0);

                const rentDot = document.getElementById('nav-red-dot-rent');
                if (rentDot) rentDot.classList.toggle('visible', totalUnreadPosts > 0);

                const totalEl = document.getElementById('total-unread');
                if (totalEl) {
                    totalEl.innerText = totalUnreadMessages;
                    totalEl.classList.toggle('hidden', totalUnreadMessages === 0);
                }
            } catch(e) { console.warn("Badge Update Error:", e); }
        }

        function loadChat(charId) {
            const data = chatData[charId];
            if (!data) return;

            // Mark as seen
            if (data.messages.length > 0) {
                const latestKey = data.messages[data.messages.length - 1].key;
                lastSeenKeys[charId] = latestKey;
                localStorage.setItem(`lastSeen_${charId}`, latestKey);
                data.hasNew = false;
            }

            updateBadges();
            document.getElementById('chat-header-name').innerText = data.name;
            document.getElementById('chat-header-avatar').src = data.avatar;

            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';

            let lastDate = '';
            data.messages.forEach(msg => {
                const isLeft = msg.side === 'left';
                const msgDate = msg.key.split(' ')[0]; // YYYY-MM-DD

                // Add Date Divider
                if (msgDate !== lastDate) {
                    chatBox.insertAdjacentHTML('beforeend', `<div class="date-divider"><span class="date-tag">${msgDate}</span></div>`);
                    lastDate = msgDate;
                }

                let bubbleContent = '';
                const durationText = msg.duration ? `${msg.duration}"` : '';

                if (msg.type === '文字消息') {
                    bubbleContent = `<div>${msg.content}</div>`;
                } else if (msg.type === '图片' || msg.type === '图文消息') {
                    bubbleContent = `<div class="msg-media-desc"><i class="far fa-image"></i> ${msg.content || '图片消息'}</div>`;
                } else if (msg.type === '语音') {
                    bubbleContent = `<div class="voice-wrapper"><div class="voice-player"><i class="fas fa-play voice-icon"></i><div class="voice-wave"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div></div><span class="voice-time">${durationText || '3"'}</span></div><div class="voice-transcription" style="font-size:14px;margin-top:4px;opacity:0.8">${msg.content}</div>`;
                } else if (msg.type === '视频') {
                    bubbleContent = `<div class="placeholder-block" style="background:#333;color:#fff;padding:10px;border-radius:8px;display:flex;align-items:center;"><i class="fas fa-play-circle" style="font-size:24px;"></i><span class="placeholder-text" style="margin-left:10px">${msg.content || '视频消息'} ${durationText}</span></div>`;
                } else if (msg.type === '语音通话' || msg.type === '视频通话') {
                    const icon = msg.type === '语音通话' ? 'phone-alt' : 'video';
                    bubbleContent = `<div class="call-bubble"><div class="call-icon-box"><i class="fas fa-${icon}"></i></div><div class="call-info"><span class="call-status">${msg.type}</span><span class="call-dur">${durationText || '已结束'}</span></div></div>`;
                }

                const senderName = isLeft ? (data.isGroup ? msg.sender : data.name) : '陈洋';
                const avatarUrl = isLeft ? (msg.senderAvatar || data.avatar) : msg.senderAvatar;

                const html = `
                    <div class="msg-row ${msg.side} ${isLeft ? data.styleClass : ''}">
                        <div class="msg-avatar ${!isLeft ? 'user_avatar' : ''}" style="background-image: url('${avatarUrl}')"></div>
                        <div class="msg-content-wrapper">
                            <div class="msg-name">${senderName}</div>
                            <div class="msg-bubble">${bubbleContent}</div>
                            <div class="msg-meta">${msg.time} ${!isLeft ? 'Read' : ''}</div>
                        </div>
                    </div>`;
                chatBox.insertAdjacentHTML('beforeend', html);
            });

            document.getElementById('chat-list-view').classList.add('hidden');
            document.getElementById('chat-detail-view').classList.add('active');

            // Auto-scroll to bottom
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 50);
        }

        function closeChat() {
            document.getElementById('chat-list-view').classList.remove('hidden');
            document.getElementById('chat-detail-view').classList.remove('active');
        }

        // ========== RENT LOGIC ==========
        function generateReviews(charName) {
            const reviews = [];
            const users = [
                "东京迷走君", "深夜食堂老板", "社畜也想谈恋爱", "GameMaster_X", "村上春树的猫",
                "周末限定男友", "新宿观测者", "纯爱战士", "咖啡中毒患者", "不愿透露姓名的K",
                "流浪诗人", "氪金玩家", "凌晨三点的云", "猫咪后院院长", "赛博朋克2026",
                "便利店便当鉴定师", "只有周五才开心", "想去海边的鱼", "银座散步", "被代码淹没",
                "秋叶原攻略组", "拉面协会会员", "透明人S", "加班到死"
            ];
            const randomUserReplies = [
                "真的吗？我也想去试试了。", "楼主好运气，我上次预约都没排上。", "确实，这个评价很中肯。", "我也觉得！完全同意！",
                "下次我也要点这个套餐。", "笑死，我也遇到过类似的情况。", "真的很值得，强推。", "楼主是懂行的。",
                "太羡慕了...", "这就是S级女友的含金量吗？", "看了评论更想去了。", "前排围观土豪。",
                "扎心了老铁。", "有一说一，确实不错。", "感觉像是打开了新世界的大门。", "我也想体验一下被‘虐’的感觉...😂"
            ];
            const erinaTemplates = [
                { text: "和绘里奈在一起，感觉自己年轻了十岁！她那停不下来的活力真的很有感染力，让我把工作的压力全忘了。她是那种能让人打心底里笑出来的女孩。", reply: "嘿嘿，就是要这种效果！下次再陪您一起疯玩一场，压力通通退散！💖" },
                { text: "以前总觉得自己生活很无趣，但和绘里奈约会那天，我觉得天空都是彩色的。她拉着我跑的时候，我真的感觉心跳快得要跳出来了。她就是我的阳光！", reply: "既然绘里奈是阳光，那您一定要记得经常来晒晒太阳哦！🎮🌟" },
                { text: "她真的太会带节奏了，气氛一直超好！那种被她全心全意关注、被她带着去尝试新事物的体验，真的太棒了。她就像一个发光体，让人忍不住想靠近。", reply: "只要能让您感受到快乐，绘里奈就会一直发光下去的！谢谢夸奖！🧐✨" },
                { text: "带她去了原宿，她穿那套JK制服的样子简直就是元气本身！不管是吃可丽饼还是拍大头贴，她总能让平凡的事情变得超级有趣。", reply: "那天的可丽饼超好吃的！下次我们要尝试那个超级巨无霸圣代！🍦✨" },
                { text: "在游乐园她拉着我跑遍了所有刺激的项目，在最高处大声喊我的名字。那一刻我真的觉得自己被全世界最亮的光照亮了。", reply: "因为那时候的您，笑起来真的超级帅气呀！🎡👋" },
                { text: "虽然只是租借约会，但她给我的那种应援感是真实的。抓娃娃抓不到的时候，她比我还紧张，抓到的时候她给我的那个拥抱，我能记一辈子。", reply: "那是给努力抓娃娃的勇者的特别奖励哦！🧸💖" },
                { text: "如果你觉得生活太沉重，一定要找绘里奈。她不会对你讲大道理，只会用她那200%的活力把你从泥潭里拽出来。她是真正的生命力之源。", reply: "生活就是要热热闹闹的才好嘛！跟紧绘里奈，不许掉队哦！🏃‍♀️💨" },
                { text: "她就像一颗彩色的糖果，咬开后全是惊喜。那种停不下来的欢笑声，真的是这个城市里最美妙的背景音乐。", reply: "那绘里奈会努力让自己变得更甜一点的！🍭🌈" }
            ];
            const ayaneTemplates = [
                { text: "绾音酱真的很懂人心！她太会照顾人的情绪了，那种全神贯注注视着你的眼神，真的让人无法拒绝。和她约会后，我感觉整个人都重新活过来了。", reply: "能够为您补充能量，是绾音最大的荣幸呢。下次见，亲爱的。☕" },
                { text: "简直是细节控的福利！她记得我随口说的每一个喜好。整个过程顺滑得不可思议，完全没有租借的感觉，真的像是和暗恋已久的女神在约会。", reply: "因为在绾音心里，您一直都是最特别的那个呀。🌙✨" },
                { text: "情商极高，外貌满分。她能精准地切换各种风格，前一秒还是知性大姐姐，下一秒就会露出害羞的少女感。这种反差真的太戳了。", reply: "谢谢您的信任，我会为您准备更多不一样的惊喜哦。🧐💕" },
                { text: "在银座散步的时候，她悄悄挽住了我的手臂，那一刻我的心跳起码有180！那种淡淡的香气和温柔的语调，简直就是理想初恋的化身。", reply: "那是只有和您在一起才会有的心动时刻哦。👗✨" },
                { text: "她陪我去了那家藏在巷子里的甜品店，她吃蛋糕时满足的表情真的太治愈了。她还主动提出过马路时牵我的手，这种被照顾的感觉真的太棒了。", reply: "因为想和您一起分享生活里所有的甜蜜呀。🍰🤝" },
                { text: "我预约了知性学姐的剧本，绾音的表现完全超出了我的期待。那种优雅又不失亲昵的分寸感，拿捏得太到位了。真的是全方位的沉浸体验。", reply: "能够让您沉浸在梦境中，就是我最大的成就感。🎭🌸" },
                { text: "在这个冰冷的城市里，绾音就像是一个温暖的奇迹。她不仅是在陪你约会，更是在用心治愈你的孤独。这钱花得太值了。", reply: "以后无论什么时候感到累了，都可以来我这里休息一下。⚓💖" },
                { text: "眼神！重点是她的眼神！那种仿佛全世界只有你一个人的注视，真的会让人彻底沦陷。她就是我梦寐而库的理想型。", reply: "因为在约会的时候，我的眼里确实只有您一个人呀。👀🌟" }
            ];

            const templates = charName === 'erina' ? erinaTemplates : ayaneTemplates;
            for(let i=0; i<20; i++) {
                const t = templates[i % templates.length];
                const user = users[Math.floor(Math.random() * users.length)];
                const rRating = Math.random();
                let rating = "5.0";
                let stars = '<i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>';

                if (rRating < 0.05) { rating = "3.5"; stars = '<i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i><i class="far fa-star"></i>'; }
                else if (rRating < 0.20) { rating = "4.0"; stars = '<i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i>'; }
                else if (rRating < 0.50) { rating = "4.5"; stars = '<i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>'; }

                let content = t.text;
                if (Math.random() > 0.7) content += " (补充：真的非常推荐，下次还会再来！)";

                let userReplies = [];
                if (Math.random() > 0.4) {
                    let replyCount = Math.random() > 0.9 ? 3 : (Math.random() > 0.7 ? 2 : 1);
                    for(let k=0; k<replyCount; k++) {
                         userReplies.push({
                             user: users[Math.floor(Math.random() * users.length)],
                             text: randomUserReplies[Math.floor(Math.random() * randomUserReplies.length)]
                         });
                    }
                }

                reviews.push({ user: user, rating: rating, stars: stars, date: `${Math.floor(Math.random()*30)+1}天前`, text: content, reply: t.reply, userReplies: userReplies });
            }
            return reviews.sort(() => Math.random() - 0.5);
        }

        let currentRentId = null;

        function openRentProfile(id) {
            currentRentId = id;
            const data = rentDb[id];
            if(!data) return;

            // Mark posts as seen
            if (data.posts && data.posts.length > 0) {
                const latestKey = data.posts[data.posts.length - 1].key;
                lastSeenPostsKeys[id] = latestKey;
                localStorage.setItem(`lastSeenPosts_${id}`, latestKey);
                data.hasNew = false;
            }
            updateBadges();

            document.getElementById('p-hero').src = data.hero;
            document.getElementById('p-avatar').src = data.avatar;
            document.getElementById('p-fullname').innerText = data.fullName;
            document.getElementById('p-tagline').innerText = data.tagline;
            document.getElementById('p-rate').innerText = data.rate;
            document.getElementById('p-rating').innerText = data.rating;
            document.getElementById('p-age').innerText = data.age;
            document.getElementById('p-type').innerText = data.type;
            document.getElementById('p-bio').innerText = data.bio;
            document.getElementById('p-map').innerText = data.map;
            document.getElementById('p-rules').innerText = data.rules;
            document.getElementById('p-schedule').innerText = data.schedule;
            document.getElementById('p-map-tags').innerHTML = data.mapTags.map(t => `<span class="tag" style="background:#000;color:#fff;border:none">${t}</span>`).join('');

            const feedContainer = document.getElementById('feed-container');
            feedContainer.innerHTML = '';
            data.posts.forEach(post => {
                const el = document.createElement('div');
                el.className = 'feed-item';
                el.onclick = () => openRentDetail('feed', post);
                el.innerHTML = `<div class="f-top"><span style="font-weight:900">@${data.name}</span><span class="f-date">${post.date}</span></div><div class="f-content">${post.text}</div><div class="f-footer"><span class="f-act"><i class="far fa-heart"></i> ${post.likes}</span><span class="f-act"><i class="far fa-comment"></i> ${post.comments}</span></div>`;
                feedContainer.appendChild(el);
            });

            const reviewContainer = document.getElementById('reviews-container');
            reviewContainer.innerHTML = '';
            data.reviews.forEach(review => {
                const el = document.createElement('div');
                el.className = 'review-item';
                el.onclick = () => openRentDetail('review', review);
                el.innerHTML = `<div class="r-header"><span class="r-user">${review.user}</span><span class="r-rating">${review.stars}</span></div><div class="r-text">${review.text}</div>`;
                reviewContainer.appendChild(el);
            });

            switchRentTab('info');
            document.getElementById('rent-profile-overlay').classList.add('active');
            document.querySelector('.page-container').classList.add('hide-dock');
        }

        function closeRentProfile() {
            const el = document.getElementById('rent-profile-overlay');
            el.classList.add('closing');
            el.classList.remove('active');
            setTimeout(() => {
                el.classList.remove('closing');
                document.querySelector('.page-container').classList.remove('hide-dock');
            }, 300);
        }

        function switchRentTab(tabName) {
            document.querySelectorAll('.rent-tab-item').forEach(el => el.classList.remove('active'));
            const activeTab = document.querySelector(`.rent-tab-item[data-tab="${tabName}"]`);
            if(activeTab) activeTab.classList.add('active');
            document.querySelectorAll('.rent-tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`rent-tab-${tabName}`).classList.add('active');
        }

        function openRentDetail(type, item) {
            const overlay = document.getElementById('rent-detail-popup');
            const contentArea = document.getElementById('rent-detail-content-area');
            const title = document.getElementById('d-header-title');
            const data = rentDb[currentRentId];

            if (type === 'feed') {
                title.innerText = "动态详情";
                let commentsHtml = '';
                const comments = item.detailComments || [];
                if (comments.length > 0) {
                    commentsHtml = `<div class="comment-list">${comments.map(c =>
                        `<div class="comment-item"><div class="c-user">${c.user}</div><div class="c-text">${c.text}</div></div>`
                    ).join('')}</div>`;
                }

                contentArea.innerHTML = `
                    <div class="detail-main-box">
                        <div style="display:flex;gap:10px;margin-bottom:10px;">
                            <img src="${data.avatar}" style="width:40px;height:40px;border:2px solid black;object-fit:cover;">
                            <div><div style="font-weight:900">${data.fullName}</div><div style="font-size:14px;color:#666">@${data.name}</div></div>
                        </div>
                        <div class="d-content">${item.text}</div>
                        <div class="d-meta">${item.date}</div>
                        ${commentsHtml}
                    </div>`;
            } else if (type === 'review') {
                title.innerText = "评价详情";

                let replyHtml = '';
                if (item.reply) {
                    const charConfig = CHARACTER_CONFIG[currentRentId];
                    const replyName = charConfig ? charConfig.name : 'STORE';
                    replyHtml = `<div class="reply-box"><span class="reply-label">${replyName}回复</span>${item.reply}</div>`;
                }

                let commentsHtml = '';
                const userReplies = item.userReplies || [];
                if (userReplies.length > 0) {
                    commentsHtml = `<div class="comment-list">${userReplies.map(c =>
                        `<div class="comment-item"><div class="c-user">${c.user}</div><div class="c-text">${c.text}</div></div>`
                    ).join('')}</div>`;
                }

                contentArea.innerHTML = `
                    <div class="detail-main-box">
                        <div class="r-header" style="margin-bottom:10px;">
                            <span class="r-user" style="font-size:16px;">${item.user}</span>
                            <span class="r-rating">${item.stars}</span>
                        </div>
                        <div class="d-content" style="font-size:14px;color:#333;">${item.text}</div>
                        ${replyHtml}
                        ${commentsHtml}
                    </div>`;
            }
            overlay.classList.add('active');
        }

        function closeRentDetail(e) {
            if(e && e.target !== e.currentTarget) return;
            document.getElementById('rent-detail-popup').classList.remove('active');
        }

        // ========== GLOBAL INIT ==========
        // Load data if available (ST environment)
        async function 渲染数据() {
            try {
                let 数据 = {};
                if (DEBUG_MODE) {
                    数据 = MOCK_DATA;
                    $('#debug-indicator').show();
                } else {
                    $('#debug-indicator').hide();
                    if (typeof Mvu !== 'undefined') {
                        const variables = Mvu.getMvuData({ type: 'message', message_id: typeof getCurrentMessageId !== 'undefined' ? getCurrentMessageId() : 'latest' });
                        数据 = _.get(variables, 'stat_data', {});
                    } else if (typeof getAllVariables !== 'undefined') {
                        const 全局变量 = getAllVariables() || {};
                        数据 = 全局变量.stat_data || {};
                    }
                }

                if (!数据 || Object.keys(数据).length === 0) {
                    if (!DEBUG_MODE) console.warn("MVU: No data found in stat_data. Using defaults.");
                } else {
                    if (!DEBUG_MODE) console.log("MVU: Loaded Data:", 数据);
                }

                // Helper to convert Record to Sorted Array
                const recordToArray = (record) => {
                    if (!record || typeof record !== 'object') return [];
                    return Object.entries(record)
                        .map(([key, value]) => ({ key, ...value }))
                        .sort((a, b) => a.key.localeCompare(b.key));
                };

                // Helper to process Chat Messages
                const processMessages = (charId, record, isGroup = false) => {
                    let userAvatar = 'https://files.catbox.moe/byn7zx.png'; // Default
                    try {
                        // Priority 1: Tavern Macro (Ver 2.4.3+)
                        if (typeof TAVERN_USER_AVATAR !== 'undefined' && TAVERN_USER_AVATAR && !TAVERN_USER_AVATAR.includes('{{')) {
                            userAvatar = TAVERN_USER_AVATAR;
                        }
                        // Priority 2: Mvu API
                        else if (typeof Mvu !== 'undefined' && Mvu.getUserAvatar) {
                            const mvuAvatar = Mvu.getUserAvatar();
                            if (mvuAvatar) userAvatar = mvuAvatar;
                        }
                        // Priority 3: Legacy Global Variables
                        else if (typeof getVariables !== 'undefined') {
                            const globalVars = getVariables({type: 'global'});
                            if (globalVars && globalVars.user_avatar) userAvatar = globalVars.user_avatar;
                        }
                    } catch(e) { console.warn("Failed to get user avatar:", e); }

                    // Also set global user avatar for other uses
                    window.CURRENT_USER_AVATAR = userAvatar;

                    const messages = recordToArray(record).map(m => {
                        let senderAvatar = null;
                        const isUser = m.发送者 === '陈洋' || m.发送者 === '陈洋';
                        if (isUser) {
                            senderAvatar = userAvatar;
                        } else {
                            const foundChar = Object.values(CHARACTER_CONFIG).find(c => c.name === m.发送者 || c.fullName.includes(m.发送者) || (c.id === 'AYANE' && m.发送者 === '林绛'));
                            senderAvatar = foundChar ? foundChar.avatar : null;
                        }
                        return {
                            key: m.key,
                            type: m.类型,
                            side: isUser ? 'right' : 'left',
                            content: m.文字内容,
                            time: m.key.split(' ')[1]?.split('_')[0] || '00:00',
                            sender: m.发送者,
                            senderAvatar: senderAvatar,
                            duration: m.时长
                        };
                    });

                    chatData[charId].messages = messages;
                    if (messages.length > 0) {
                        const latestKey = messages[messages.length - 1].key;
                        if (latestKey !== lastSeenKeys[charId]) {
                            chatData[charId].hasNew = true;
                        }
                    }
                };

                // Helper to process Social Posts
                const processSocial = (charId, record) => {
                    if (!rentDb[charId]) return;
                    const posts = recordToArray(record).map((p, idx) => {
                        const comments = Object.keys(p.评论列表 || {}).length;
                        const cacheKey = `${charId}_${p.key}`;
                        if (!feedLikesCache[cacheKey]) {
                            feedLikesCache[cacheKey] = Math.floor(Math.random() * 500) + 50;
                        }
                        return {
                            id: charId + idx,
                            type: 'feed',
                            date: p.key,
                            likes: feedLikesCache[cacheKey],
                            comments: comments,
                            text: p.动态内容,
                            detailComments: Object.entries(p.评论列表 || {}).map(([user, text]) => ({ user, text })),
                            key: p.key
                        };
                    });
                    rentDb[charId].posts = posts;

                    if (posts.length > 0) {
                        const latestKey = posts[posts.length - 1].key;
                        if (latestKey !== lastSeenPostsKeys[charId]) {
                            rentDb[charId].hasNew = true;
                        }
                    }
                };

                // --- 1. Character Data Rendering ---
                Object.values(CHARACTER_CONFIG).forEach(char => {
                    const prefix = char.varPrefix;
                    const charData_v = _.get(数据, prefix, {});

                    // Love & Trust
                    const love = parseFloat(_.get(charData_v, '好感度', 0));
                    const trust = parseFloat(_.get(charData_v, '信赖度', 0));
                    const max = 400;

                    $(`#${char.id}-love-text`).text(`${love}/${max}`);
                    $(`#${char.id}-love-bar`).css('width', `${(love/max)*100}%`);
                    $(`#${char.id}-detail-love-text`).text(`${love}/${max}`);
                    $(`#${char.id}-detail-love-bar`).css('width', `${(love/max)*100}%`);

                    $(`#${char.id}-trust-text`).text(`${trust}/${max}`);
                    $(`#${char.id}-trust-bar`).css('width', `${(trust/max)*100}%`);
                    $(`#${char.id}-detail-trust-text`).text(`${trust}/${max}`);
                    $(`#${char.id}-detail-trust-bar`).css('width', `${(trust/max)*100}%`);

                    // Stage/Status
                    const stage = _.get(charData_v, '关系阶段', '査定の対象');
                    $(`#${char.id}-stage-tag`).text(stage);
                    $(`#${char.id}-stage-text`).text(stage);

                    // Contact & Love Status
                    const hasContact = _.get(charData_v, '拥有联系方式', false);
                    $(`#${char.id}-contact-icon i`).attr('class', hasContact ? 'fas fa-comment-alt' : 'fas fa-lock');
                    $(`#${char.id}-contact-icon`).css('color', hasContact ? '#ff4757' : '#ccc');
                    $(`#${char.id}-contact-text`).text(hasContact ? '已交换' : '未交换');

                    const isInLove = _.get(charData_v, '恋爱状态', false);
                    $(`#${char.id}-love-icon i`).attr('class', isInLove ? 'fas fa-heart' : 'fas fa-heart-broken');
                    $(`#${char.id}-love-icon`).css('color', isInLove ? '#ff4757' : '#ccc');
                    $(`#${char.id}-love-status-text`).text(isInLove ? '交往中' : '单身');
                    $(`#${char.id}-status-text`).text(isInLove ? 'PRIVATE / 专属中' : 'AVAILABLE / 营业中');
                    $(`.card-${char.id} .status-light`).css('background', isInLove ? '#ff4757' : '#0f0');

                    // Determine Effective Mode (Respect Manual Override if In Love)
                    let effectiveMode = 'business';
                    if (isInLove) {
                         // Default to private if no override is set, OR use the override
                         const override = charViewState[char.id] && charViewState[char.id].override;
                         effectiveMode = override ? override : 'private';
                    } else {
                         effectiveMode = 'business';
                         if(charViewState[char.id]) charViewState[char.id].override = null; // Reset
                    }
                    const isPrivate = effectiveMode === 'private';

                    // Update detail page sprite visibility (Double Buffering)
                    // We check if src needs update (in case config changed), but mostly we just toggle classes
                    const $page = $(`#page-${char.id}`);
                    const $imgBiz = $page.find('.char-img-business');
                    const $imgPriv = $page.find('.char-img-private');

                    // Ensure sources are correct (idempotent)
                    if ($imgBiz.attr('src') !== char.heroOutside) $imgBiz.attr('src', char.heroOutside);
                    if ($imgPriv.attr('src') !== char.heroInside) $imgPriv.attr('src', char.heroInside);

                    // Toggle Visibility
                    $imgBiz.toggleClass('active', !isPrivate);
                    $imgPriv.toggleClass('active', isPrivate);

                    $page.toggleClass('is-in-love', isInLove); // Keep this based on real status for styles

                    // Business/Private Toggle UI
                    if (isPrivate) {
                        $(`#${char.id}-business-status`).text('OFF').css('color', '#666');
                        $(`#${char.id}-private-status`).text('ON').css('color', '#ff4757');
                        $(`#${char.id}-toggle-business`).removeClass('on');
                        $(`#${char.id}-toggle-private`).addClass('on');
                        $(`#${char.id}-toggle-business`).next('span').text('营业中 OFF');
                        $(`#${char.id}-toggle-private`).next('span').text('私生活 ON');
                    } else {
                        $(`#${char.id}-business-status`).text('ON').css('color', '#2ed573');
                        $(`#${char.id}-private-status`).text('OFF').css('color', '#666');
                        $(`#${char.id}-toggle-business`).addClass('on');
                        $(`#${char.id}-toggle-private`).removeClass('on');
                        $(`#${char.id}-toggle-business`).next('span').text('营业中 ON');
                        $(`#${char.id}-toggle-private`).next('span').text('私生活 OFF');
                    }

                    // Mind Scan Update
                    if (charData_v.$表心声) $(`#card-${char.id} .bubble`).text(charData_v.$表心声);
                    if (charData_v.$里心声) $(`#card-${char.id} .inner-text`).html(charData_v.$里心声.replace(/\n/g, '<br>'));

                    // Mood (Directly from variable string)
                    const moodVal = _.get(charData_v, '心情', "平静");
                    $(`#card-${char.id} .mood-info span`).text(`MOOD: ${moodVal}`);

                    // Pregnancy Status
                    const isPregnant = _.get(charData_v, '受孕状态', false);
                    const pregDate = _.get(charData_v, '受孕日期', '');
                    const $pregBadge = $(`#${char.id}-pregnancy-badge`);
                    if (isPregnant) {
                        $pregBadge.addClass('active');
                        $(`#${char.id}-pregnancy-date`).text(pregDate || '日期未知');
                    } else {
                        $pregBadge.removeClass('active');
                    }

                    // Special variables (like CV, Fans for Ayane)
                    if (char.id === 'AYANE') {
                        const trueName = _.get(charData_v, '透露真名', false);
                        $('#AYANE-secret-text').text(trueName ? 'REAL NAME: 林 绛' : 'REAL NAME: ???');
                        $('#AYANE-cv-text').text(`CV学习: ${_.get(charData_v, 'CV学习进度', '基础阶段')}`);
                        $('#AYANE-fans-text').text(`粉丝数: ${_.get(charData_v, '粉丝数', 0)}人`);
                    }

                    // Chat Messages
                    processMessages(char.id, _.get(charData_v, '$消息记录', {}));

                    // Social Posts
                    processSocial(char.id, _.get(charData_v, '$社交动态', {}));

                    // Update Banner Badge
                    const badge = document.getElementById(`banner-badge-${char.id}`);
                    if (badge && rentDb[char.id]) {
                        badge.style.display = rentDb[char.id].hasNew ? 'block' : 'none';
                    }
                });

                // --- 2. Group Chat & Others ---
                processMessages('group', _.get(数据, '$三人群组.消息记录', {}), true);

                // Update Chat List UI
                const listContainer = document.getElementById('chat-list-container');
                if (listContainer) {
                    let html = '';
                    // Character chats
                    Object.values(chatData).forEach(char => {
                        if (char.messages.length === 0) return;
                        const lastMsg = char.messages[char.messages.length - 1];
                        const avatar = char.avatar;

                        let previewText = lastMsg.content || '';
                        const typeMap = { '图片': '[图片]', '图文消息': '[图文]', '语音': '[语音]', '视频': '[视频]', '语音通话': '[语音通话]', '视频通话': '[视频通话]' };
                        if (typeMap[lastMsg.type]) previewText = `${typeMap[lastMsg.type]} ${previewText}`;

                        html += `
                            <div class="chat-item" onclick="loadChat('${char.id}')">
                                <div class="item-avatar-box">
                                    <img src="${avatar}" class="item-avatar char-avatar">
                                    <div id="badge-${char.id}" class="item-badge ${char.hasNew ? '' : 'hidden'}">N</div>
                                </div>
                                <div class="item-content">
                                    <div class="item-top">
                                        <div class="item-name">${char.name}</div>
                                        <div class="item-time">${lastMsg.time}</div>
                                    </div>
                                    <div class="item-msg">${previewText}</div>
                                </div>
                            </div>`;
                    });
                    listContainer.innerHTML = html;
                }
                // --- 5. News Speed Report ---
                let newsRecord = _.get(数据, '$新闻速报.速报列表') || _.get(数据, '新闻速报.速报列表');

                // Fallback to defaults if empty (ensure popup has content)
                if (!newsRecord || _.isEmpty(newsRecord)) {
                    newsRecord = {
                        "新闻1": { "来源": "TBS新闻", "标题": "新宿歌舞伎町今晚将加强夜间巡逻", "正文": "由于近期深夜骚乱频发，警视厅决定从今日起在歌舞伎町一番街及周边区域增派警力，重点盘查可疑人员。请各位市民及游客注意安全，随身携带身份证件。" },
                        "新闻2": { "来源": "《ViVi》", "标题": "秋季约会妆容特辑：清透底妆是关键", "正文": "本季最流行的'微醺感'妆容教程大公开！只需三步，就能打造出让男朋友怦然心动的温柔氛围。重点在于腮红的晕染范围和唇釉的水光感哦。" },
                        "新闻3": { "来源": "Yahoo!ニュース", "标题": "租借服务市场持续升温，业界呼吁规范", "正文": "最新的市场调查报告显示，'情感陪伴'类服务的需求量在过去一个季度增长了 300%。专家分析认为，现代都市人的孤独感是推动这一产业爆发的主要原因。" }
                    };
                }

                const newsKeys = Object.keys(newsRecord);
                if (newsKeys.length > 0) {
                    // Generate Ticker (No brackets, Clickable)
                    const singleSet = _.map(newsRecord, n =>
                        `<span class="marquee-item" onclick="$('#news-modal').addClass('active')">${n.来源} : ${n.标题}</span>`
                    ).join('');

                    const $marquee = $('.marquee-content');
                    $marquee.html(singleSet + singleSet);

                    // Generate News Modal List
                    const newsListHtml = _.map(newsRecord, n => `
                        <div class="news-item-row">
                            <div class="news-source">${n.来源 || 'NEWS'}</div>
                            <div class="news-title">${n.标题 || '...'}</div>
                            <div class="news-body-text" style="font-size:16px; color:#555; line-height:1.4; margin-top:5px;">${n.正文 || ''}</div>
                        </div>
                    `).join('');
                    $('#news-list-container').html(newsListHtml);
                }

                // --- 6. World Info ---
                if (_.has(数据, '世界信息.时间')) $('#world-date').text(数据.世界信息.时间);
                if (_.has(数据, '世界信息.地点')) $('#world-location').text(数据.世界信息.地点);

                updateBadges();

            } catch(e) { console.error("MVU Render Error:", e); }
        }
        $(async () => {
            if (!DEBUG_MODE) {
                if (typeof waitGlobalInitialized !== 'undefined') {
                    await waitGlobalInitialized('Mvu');
                }
                if (typeof waitUntil !== 'undefined') {
                    await waitUntil(() => {
                        const vars = typeof getVariables !== 'undefined' ? getVariables({type: 'message'}) : null;
                        return vars && vars.stat_data;
                    });
                }
            }
            渲染数据();
            setInterval(渲染数据, 2000);

            function adjustLayout() {
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                const container = document.querySelector('.page-container');
                if (!container) return;

                // Threshold for Desktop Mode
                const isDesktop = winW > 600;

                const baseW = 600;
                const baseH = 800;

                // Reset styles common to both
                container.style.width = `${baseW}px`;
                container.style.height = `${baseH}px`;
                container.style.maxWidth = 'none';
                container.style.maxHeight = 'none';
                container.style.margin = '0';
                container.style.position = 'relative';
                container.style.aspectRatio = 'auto';
                container.style.zoom = '';
                container.style.border = '4px solid var(--line-color)';

                if (isDesktop) {
                    // Desktop Mode: Contain behavior
                    // Reset body to fill viewport
                    document.body.style.width = '100vw';
                    document.body.style.height = '100vh';
                    document.body.style.overflow = 'hidden';

                    // Scale to fit
                    let scale = Math.min(winW / baseW, winH / baseH);

                    container.style.transform = `scale(${scale})`;
                    container.style.transformOrigin = 'top center';

                    // Center vertically
                    const scaledHeight = baseH * scale;
                    if (scaledHeight < winH) {
                        container.style.marginTop = `${(winH - scaledHeight) / 2}px`;
                    } else {
                        container.style.marginTop = '0';
                    }
                } else {
                    // Mobile Mode: Width Match + Shrink Wrap
                    let scale = winW / baseW;

                    container.style.transform = `scale(${scale})`;
                    container.style.transformOrigin = 'top left'; // Align to top-left
                    container.style.marginTop = '0';

                    // Calculate exact visual height
                    const scaledHeight = baseH * scale;

                    // Force body to match visual height to remove gap
                    document.body.style.width = `${winW}px`;
                    document.body.style.height = `${scaledHeight}px`;
                    document.body.style.overflow = 'hidden';

                    // Pull up the layout flow
                    container.style.marginBottom = `-${baseH - scaledHeight}px`;
                    container.style.marginRight = `-${baseW - (baseW * scale)}px`;
                }
            }

            window.addEventListener('resize', adjustLayout);
            adjustLayout();
        });

    </script>
</div>
</body>
</html>
